/*

Quixe
=====

Built: 2015-04-03

Quixe -- a Glulx VM interpreter written in Javascript
GiDispa -- a GlkAPI dispatch layer for Quixe

Designed by Andrew Plotkin <erkyrath@eblong.com>
Copyright (c) 2010-2015 Andrew Plotkin
<http://eblong.com/zarf/glulx/quixe/>

*/
Quixe=function(){function quixe_prepare(a,b){game_image=a;var c,d,e=game_image.slice(0,64);for(c=0;c<e.length;c++)d=e[c].toString(16),d.length<2&&(d="0"+d),e[c]=d;game_signature=e.join(""),b&&(opt_rethrow_exceptions=b.rethrow_exceptions)}function quixe_init(){if(vm_started)return void Glk.fatal_error("Quixe was inited twice!");try{setup_bytestring_table(),setup_operandlist_table(),setup_vm(),execute_loop()}catch(a){if(Glk.fatal_error("Quixe init: "+show_exception(a)),opt_rethrow_exceptions)throw a}}function quixe_resume(){try{done_executing=vm_stopped,execute_loop()}catch(a){if(Glk.fatal_error("Quixe run: "+show_exception(a)),opt_rethrow_exceptions)throw a}}function show_exception(a){if("string"==typeof a)return a;var b=a.toString();return a.message&&(b=b+" "+a.message),a.fileName&&(b=b+" "+a.fileName),a.lineNumber&&(b=b+" line:"+a.lineNumber),a.name&&(b=b+" "+a.name),a.number&&(b=b+" "+a.number),b}function qlog(a){window.console&&console.log?console.log(a):window.opera&&opera.postError&&opera.postError(a)}function qobjdump(a,b){var c,d;if(a instanceof Array){b&&b--;var e=a.map(function(a){return qobjdump(a,b)});return"["+e.join(",")+"]"}if(!(a instanceof Object))return""+a;d=[];for(c in a){var f=a[c];b&&f instanceof Object&&(f=qobjdump(f,b-1)),d.push(c+":"+f)}return"{ "+d.join(", ")+" }"}function setup_bytestring_table(){var a,b;for(a=0;256>a;a++)b=a.toString(16),16>a&&(b="0"+b),bytestring_table[a]=b;for(a=0;256>a;a++)b=a>=32&&127>a?34==a||39==a||92==a?"\\"+String.fromCharCode(a):String.fromCharCode(a):10==a?"\\n":"\\x"+bytestring_table[a],quotechar_table[a]=b}function ByteRead4(a,b){return 16777216*a[b]+65536*a[b+1]+256*a[b+2]+a[b+3]}function ByteRead2(a,b){return 256*a[b]+a[b+1]}function ByteRead1(a,b){return a[b]}function Mem1(a){return memmap[a]}function Mem2(a){return 256*memmap[a]+memmap[a+1]}function Mem4(a){return 16777216*memmap[a]+65536*memmap[a+1]+256*memmap[a+2]+memmap[a+3]}function MemW1(a,b){memmap[a]=255&b}function MemW2(a,b){memmap[a]=b>>8&255,memmap[a+1]=255&b}function MemW4(a,b){memmap[a]=b>>24&255,memmap[a+1]=b>>16&255,memmap[a+2]=b>>8&255,memmap[a+3]=255&b}function BytePushString(a,b){for(var c=0;c<b.length;c++)a.push(b.charCodeAt(c))}function BytePush4(a,b){a.push(b>>24&255),a.push(b>>16&255),a.push(b>>8&255),a.push(255&b)}function BytePush2(a,b){a.push(b>>8&255),a.push(255&b)}function BytePush1(a,b){a.push(255&b)}function ByteWrite4(a,b,c){a[b]=c>>24&255,a[b+1]=c>>16&255,a[b+2]=c>>8&255,a[b+3]=255&c}function ByteReadString(a,b,c){return String.fromCharCode.apply(this,a.slice(b,b+c))}function QuoteMem1(a){return memmap[a]>=128?"0xffffff"+bytestring_table[memmap[a]]:"0x"+bytestring_table[memmap[a]]}function QuoteMem2(a){return memmap[a]>=128?"0xffff"+bytestring_table[memmap[a]]+bytestring_table[memmap[a+1]]:memmap[a]?"0x"+bytestring_table[memmap[a]]+bytestring_table[memmap[a+1]]:"0x"+bytestring_table[memmap[a+1]]}function QuoteMem4(a){return memmap[a]?"0x"+bytestring_table[memmap[a]]+bytestring_table[memmap[a+1]]+bytestring_table[memmap[a+2]]+bytestring_table[memmap[a+3]]:memmap[a+1]?"0x"+bytestring_table[memmap[a+1]]+bytestring_table[memmap[a+2]]+bytestring_table[memmap[a+3]]:memmap[a+2]?"0x"+bytestring_table[memmap[a+2]]+bytestring_table[memmap[a+3]]:"0x"+bytestring_table[memmap[a+3]]}function ReadArgByte(a){return 4294967295==a?255&frame.valstack.pop():Mem1(a)}function WriteArgByte(a,b){4294967295==a?frame.valstack.push(255&b):MemW1(a,b)}function ReadArgWord(a){return 4294967295==a?frame.valstack.pop():Mem4(a)}function WriteArgWord(a,b){4294967295==a?frame.valstack.push(b):MemW4(a,b)}function ReadStructField(a,b){return 4294967295==a?frame.valstack.pop():Mem4(a+4*b)}function WriteStructField(a,b,c){4294967295==a?frame.valstack.push(c):MemW4(a+4*b,c)}function SetResumeStore(a){resumevalue=a}function CharToString(a){return 65536>a?String.fromCharCode(a):(a-=65536,String.fromCharCode(55296+(a>>10),56320+(1023&a)))}function QuoteCharToString(a){if(256>a)return quotechar_table[a];if(65536>a){for(a=a.toString(16);a.length<4;)a="0"+a;return"\\u"+a}var b;return a-=65536,b=55296+(a>>10),a=56320+(1023&a),"\\u"+b.toString(16)+"\\u"+a.toString(16)}function QuoteStr1ToString(a){return QuoteCharToString(a.charCodeAt(0))}function QuoteEscapeString(a){return a=a.replace(regexp_string_unsafe,QuoteStr1ToString),'"'+a+'"'}function fatal_error(a){var b,c;if(arguments.length>1){for(a+=" (",b=1;b<arguments.length;b++)c=arguments[b],c="number"==typeof c?c.toString(16):""+c,1!=b&&(a+=" "),a+=c;a+=")"}throw qlog(a),a}function make_code(val,arg){return eval(void 0===arg?"function _func() {\n"+val+"\n}":"function _func("+arg+") {\n"+val+"\n}"),_func}function VMFunc(a,b,c,d){this.funcaddr=a,this.startpc=b,this.functype=Mem1(a),this.pathaddrs={},this[0]={},this[1]={},this[2]={},this.locallen=null,this.localsformat=c,this.rawformat=d,this.localsindex=[];var e,f,g=0;for(e=0;e<this.localsformat.length;e++){var h=this.localsformat[e];if(4==h.size)for(;3&g;)g++;else if(2==h.size)for(;1&g;)g++;for(f=0;f<h.count;f++)this.localsindex.push({size:h.size,pos:g}),g+=h.size}for(;3&g;)g++;this.locallen=g}function StackFrame(a){var b;for(this.vmfunc=a,this.depth=null,this.framestart=null,this.framelen=null,this.valstack=[],this.localspos=null,this.localsindex=a.localsindex,this.locals=[],b=0;b<this.localsindex.length;b++){var c=this.localsindex[b];this.locals[c.pos]=0}this.framelen=8+a.rawformat.length+a.locallen}function clone_stackframe(a){var b=new StackFrame(a.vmfunc);return b.depth=a.depth,b.framestart=a.framestart,b.framelen=a.framelen,b.valstack=a.valstack.slice(0),b.localspos=a.localspos,b.locals=a.locals.slice(0),b.framelen=a.framelen,b}function push_serialized_stackframe(a,b){BytePush4(b,a.framelen);var c=a.vmfunc.rawformat;BytePush4(b,8+c.length);for(var d=0;d<c.length;d++)b.push(c[d]);for(var d=0;d<a.vmfunc.localsindex.length;d++){var e=a.vmfunc.localsindex[d];if(4==e.size){for(;3&b.length;)b.push(0);BytePush4(b,a.locals[e.pos])}else if(2==e.size){for(;1&b.length;)b.push(0);BytePush2(b,a.locals[e.pos])}else BytePush1(b,a.locals[e.pos])}for(;3&b.length;)b.push(0);for(var d=0;d<a.valstack.length;d++)BytePush4(b,a.valstack[d])}function pop_deserialized_stackframe(a,b){var c=ByteRead4(a,a.length-4);if(0>c||c>=a.length)return void qlog("Bad frameptr in serialized stack frame");a=a.splice(c,a.length);var d=ByteRead4(a,0),e=ByteRead4(a,4);if(e!=8+b.rawformat.length)return void qlog("LocalsPos in save file ("+e+") doesn't match game image ("+(8+b.rawformat.length)+")");if(d!=e+b.locallen)return void qlog("FrameLen in save file ("+d+") doesn't match game image ("+(e+b.locallen)+")");var f=new StackFrame(b);f.framestart=c;for(var g=0;g<f.vmfunc.localsindex.length;g++){var h=f.vmfunc.localsindex[g];f.locals[h.pos]=4==h.size?ByteRead4(a,4+e+h.pos):2==h.size?ByteRead2(a,4+e+h.pos):ByteRead1(a,4+e+h.pos)}for(var i=d;i<a.length;i+=4)f.valstack.push(ByteRead4(a,i));return f}function VMTextEnv(a,b){0==a&&fatal_error("Tried to create a VMTextEnv for address zero."),this.addr=a,this.cacheable=void 0!==b,this.decoding_tree=b,this.vmstring_tables=[],this.cacheable&&(this.vmstring_tables[0]={},this.vmstring_tables[1]={},this.vmstring_tables[2]={})}function setup_operandlist_table(){function a(a,b){this.argsize=b?b:4,this.numops=a.length;for(var c=[],d=0;d<a.length;d++)c.push(a.charAt(d));this.formlist=c}var b=new a(""),c=new a("L"),d=new a("LL"),e=new a("LLL"),f=new a("LLLL"),g=new a("LS"),h=new a("LLS"),i=new a("LLLLLLS"),j=new a("LLLLLLLS"),k=new a("LLSS"),l=new a("LC"),m=new a("LLC"),n=new a("LLLC"),o=new a("LLLLC"),p=new a("ES"),q=new a("LES"),r=new a("EES"),s=new a("F"),t=new a("LF"),u=new a("LLF"),v=new a("EF"),w=new a("EF",1),x=new a("EF",2),y=new a("S"),z=new a("SS"),A=new a("CL"),B=new a("C");operandlist_table={0:b,16:r,17:q,18:h,19:h,20:h,21:p,24:r,25:r,26:r,27:p,28:h,29:h,30:h,32:c,34:d,35:d,36:e,37:e,38:e,39:e,40:e,41:e,42:e,43:e,44:e,45:e,48:m,49:c,50:A,51:d,52:d,64:v,65:x,66:w,68:g,69:g,72:h,73:h,74:h,75:h,76:e,77:e,78:e,79:e,80:s,81:t,82:b,83:d,84:c,112:c,113:c,114:c,115:c,256:h,257:c,258:y,259:g,260:c,272:g,273:c,288:b,289:y,290:b,291:l,292:t,293:B,294:s,295:d,304:u,320:y,321:c,328:z,329:d,336:j,337:j,338:i,352:l,353:m,354:n,355:o,368:d,369:e,376:g,377:c,384:d,385:d,400:g,401:g,402:g,408:g,409:g,416:h,417:h,418:h,419:h,420:k,424:g,425:g,426:g,427:h,432:g,433:g,434:g,435:g,436:g,437:g,438:h,448:f,449:f,450:e,451:e,452:e,453:e,456:d,457:d}}function oputil_record_funcop(a){if(0==a.mode)return"null";var b="m"+a.mode;if(null!=a.argsize&&(b=b+"s"+a.argsize),null!=a.addr&&(b=b+"a"+a.addr),funcop_cache.key)return"funcop_cache."+b;var c={key:b,mode:a.mode,argsize:a.argsize,addr:a.addr};return funcop_cache[b]=c,"funcop_cache."+b}function oputil_store(a,b,c){switch(b.mode){case 8:if(4==b.argsize){var d=c[0];if("0"===d)return a.offstack.push(c),void a.code.push("// push to offstack: "+c);if("_"===d)return push_offstack_holdvar(a,c),void a.code.push("// re-push to offstack: "+c)}return holdvar=alloc_holdvar(a,!0),a.offstack.push(holdvar),void a.code.push(4==b.argsize?holdvar+"=("+c+");":2==b.argsize?holdvar+"=0xffff&("+c+");":holdvar+"=0xff&("+c+");");case 0:return void a.code.push("("+c+");");case 11:if(4==b.argsize){var d=c[0];if("0"===d)return store_offloc_value(a,b.addr,c,!1),void a.code.push("// store to offloc["+b.addr+"]: "+c);if("_"===d)return store_offloc_value(a,b.addr,c,!0),void a.code.push("// re-store to offloc["+b.addr+"]: "+c)}return store_offloc_value(a,b.addr,void 0),void a.code.push(4==b.argsize?"frame.locals["+b.addr+"]=("+c+");":2==b.argsize?"frame.locals["+b.addr+"]=(0xffff &"+c+");":"frame.locals["+b.addr+"]=(0xff &"+c+");");case 15:return void a.code.push(4==b.argsize?"MemW4("+b.addr+","+c+");":2==b.argsize?"MemW2("+b.addr+","+c+");":"MemW1("+b.addr+","+c+");");default:fatal_error("Unknown addressing mode in store func operand.")}}function oputil_push_callstub(a,b,c){void 0===c&&(c=a.cp),a.code.push("frame.valstack.push("+b+","+c+",frame.framestart);")}function oputil_push_substring_callstub(a){a.code.push("if (!substring) { substring=true;"),a.code.push("frame.valstack.push(0x11,0,nextcp,frame.framestart);"),a.code.push("}")}function oputil_unload_offstate(a,b){var c;if(a.code.push("// unload offstate: "+a.offstack.length+" stack"+(a.offloc.length?", plus locs":"")+(b?" (conditional)":"")),a.offstack.length&&a.code.push("frame.valstack.push("+a.offstack.join(",")+");"),a.offloc.length)for(c=0;c<a.offloc.length;c++)void 0!==a.offloc[c]&&a.offlocdirty[c]&&a.code.push("frame.locals["+c+"]="+a.offloc[c]+";");if(!b){var d;for(c=0;c<a.offloc.length;c++)d=a.offloc[c],void 0!==d&&void 0!==a.holduse[d]&&(a.holduse[d]=!1);for(a.offloc.length=0,a.offlocdirty.length=0;a.offstack.length;)d=a.offstack.pop(),void 0!==a.holduse[d]&&(a.holduse[d]=!1)}}function oputil_flush_string(a){if(0!=a.buffer.length){var b=a.buffer.join("");a.buffer.length=0,a.code.push("Glk.glk_put_jstring("+QuoteEscapeString(b)+");")}}function oputil_signify_operand(a,b,c){var d;if(quot_isconstant(b))return d=Number(b),2147483648&d?""+(d-4294967296):b;if(d="("+b+"&0xffffffff)",c){var e=alloc_holdvar(a);return a.code.push(e+"="+d+";"),e}return d}function oputil_decode_float(a,b,c){var d;if(quot_isconstant(b))return d=Number(b),2147483648==d?"-0":""+decode_float(d);if(d="decode_float("+b+")",c){var e=alloc_holdvar(a);return a.code.push(e+"="+d+";"),e}return d}function oputil_perform_jump(a,b,c){if(quot_isconstant(b)){var d=Number(b);if(0==d||1==d)c?(a.code.push("// quashing offstack for unconditional return: "+a.offstack.length),a.offstack.length=0,a.offloc.length=0,a.offlocdirty.length=0):a.code.push("// ignoring offstack for conditional return: "+a.offstack.length),a.code.push("leave_function();"),a.code.push("pop_callstub("+d+");");else{oputil_unload_offstate(a,!c);var e=a.cp+d-2>>>0;a.code.push("pc = "+e+";"),a.vmfunc.pathaddrs[e]=!0}}else oputil_unload_offstate(a,!c),a.code.push("if (("+b+")==0 || ("+b+")==1) {"),a.code.push("leave_function();"),a.code.push("pop_callstub("+b+");"),a.code.push("}"),a.code.push("else {"),a.code.push("pc = ("+a.cp+"+("+b+")-2) >>>0;"),a.code.push("}");a.code.push("return;")}function alloc_holdvar(a,b){for(var c,d=0;;){if(c="_hold"+d,!a.holduse[c])return a.holduse[c]=b?1:!0,c;d++}}function pop_offstack_holdvar(a){var b=a.offstack.pop();if(quot_isconstant(b))return b;var c=a.holduse[b];return(isNaN(c)||c===!1||c===!0)&&fatal_error("Offstack variable not marked as stack.",b),c--,0==c&&(c=!0),a.holduse[b]=c,b}function push_offstack_holdvar(a,b){a.offstack.push(b);var c=a.holduse[b];c&&c!==!0?c++:c=1,a.holduse[b]=c}function store_offloc_value(a,b,c,d){var e=a.offloc[b];if(e&&quot_isholdvar(e)){var f=a.holduse[e];f--,0==f&&(f=!0),a.holduse[e]=f}if(void 0===c)return a.offloc[b]=void 0,void(a.offlocdirty[b]=!1);if(a.offloc[b]=c,a.offlocdirty[b]=!0,d){var g=c,f=a.holduse[g];f&&f!==!0?f++:f=1,a.holduse[g]=f}}function transfer_to_offstack(a,b){for(var c;a.offstack.length<b;)c=alloc_holdvar(a,!0),a.offstack.unshift(c),a.code.push(c+"=frame.valstack.pop();")}function quot_isconstant(a){return"0"===a[0]}function quot_isholdvar(a){return"_"===a[0]}function parse_operands(a,b,c,d){var e,f,g,h,i,j,k;for(d.desttype=0,d.numops=c.numops,e=b,b+=c.numops+1>>1,f=0;f<c.numops;f++){0==(1&f)?(g=Mem1(e),h=15&g):(h=g>>4&15,e++);var l=c.formlist[f];if("L"!=l)if("E"!=l)if("S"!=l)if("F"!=l)if("C"!=l)fatal_error("Unknown operand type.",l);else{switch(h){case 8:d[f]="3,0";continue;case 0:d[f]="0,0";continue}if(h>=9&&11>=h){9==h?(j=Mem1(b),b++):10==h?(j=Mem2(b),b+=2):11==h&&(j=Mem4(b),b+=4),d[f]="2,"+j;continue}switch(h){case 15:j=Mem4(b)+ramstart,b+=4;break;case 14:j=Mem2(b)+ramstart,b+=2;break;case 13:j=Mem1(b)+ramstart,b++;break;case 7:j=Mem4(b),b+=4;break;case 6:j=Mem2(b),b+=2;break;case 5:j=Mem1(b),b++;break;default:fatal_error("Unknown addressing mode in store operand.")}d[f]="1,"+j}else{var m=d.func_store;switch(h){case 8:m.mode=8,m.argsize=c.argsize,d[f]=m;continue;case 0:m.mode=0,m.argsize=c.argsize,d[f]=m;continue}if(h>=9&&11>=h){9==h?(j=Mem1(b),b++):10==h?(j=Mem2(b),b+=2):11==h&&(j=Mem4(b),b+=4),m.mode=11,m.addr=j,m.argsize=c.argsize,d[f]=m;continue}switch(h){case 15:j=Mem4(b)+ramstart,b+=4;break;case 14:j=Mem2(b)+ramstart,b+=2;break;case 13:j=Mem1(b)+ramstart,b++;break;case 7:j=Mem4(b),b+=4;break;case 6:j=Mem2(b),b+=2;break;case 5:j=Mem1(b),b++;break;default:fatal_error("Unknown addressing mode in store operand.")}m.mode=15,m.addr=j,m.argsize=c.argsize,d[f]=m}else{switch(h){case 8:k=alloc_holdvar(a,!0),a.offstack.push(k),d[f]=k+"=(";continue;case 0:d[f]="(";continue}if(h>=9&&11>=h){9==h?(j=Mem1(b),b++):10==h?(j=Mem2(b),b+=2):11==h&&(j=Mem4(b),b+=4),4==c.argsize?(k=alloc_holdvar(a,!0),store_offloc_value(a,j,k,!1),d[f]=k+"=("):2==c.argsize?(store_offloc_value(a,j,void 0),d[f]="frame.locals["+j+"]=(0xffff &"):(store_offloc_value(a,j,void 0),d[f]="frame.locals["+j+"]=(0xff &");continue}switch(h){case 15:j=Mem4(b)+ramstart,b+=4;break;case 14:j=Mem2(b)+ramstart,b+=2;break;case 13:j=Mem1(b)+ramstart,b++;break;case 7:j=Mem4(b),b+=4;break;case 6:j=Mem2(b),b+=2;break;case 5:j=Mem1(b),b++;break;default:fatal_error("Unknown addressing mode in store operand.")}i=4==c.argsize?"MemW4("+j+",":2==c.argsize?"MemW2("+j+",":"MemW1("+j+",",d[f]=i}else{switch(h){case 8:d[f]=a.offstack.length?pop_offstack_holdvar(a):"frame.valstack.pop()";continue;case 0:d[f]="0";continue;case 1:i=QuoteMem1(b),b++,d[f]=i;continue;case 2:i=QuoteMem2(b),b+=2,d[f]=i;continue;case 3:i=QuoteMem4(b),b+=4,d[f]=i;continue}if(h>=9&&11>=h){if(9==h?(j=Mem1(b),b++):10==h?(j=Mem2(b),b+=2):11==h&&(j=Mem4(b),b+=4),void 0!==a.offloc[j]){d[f]=a.offloc[j];continue}i=4==c.argsize?"frame.locals["+j+"]":2==c.argsize?"frame.locals["+j+"] & 0xffff":"frame.locals["+j+"] & 0xff",k=alloc_holdvar(a,!0),a.code.push(k+"=("+i+");"),a.offloc[j]=k,a.offlocdirty[j]=!1,d[f]=k;continue}switch(h){case 15:j=Mem4(b)+ramstart,b+=4;break;case 14:j=Mem2(b)+ramstart,b+=2;break;case 13:j=Mem1(b)+ramstart,b++;break;case 7:j=Mem4(b),b+=4;break;case 6:j=Mem2(b),b+=2;break;case 5:j=Mem1(b),b++;break;default:fatal_error("Unknown addressing mode in load operand.")}i=4==c.argsize?"Mem4("+j+")":2==c.argsize?"Mem2("+j+")":"Mem1("+j+")",d[f]=i}else{switch(h){case 8:a.offstack.length?d[f]=pop_offstack_holdvar(a):(k=alloc_holdvar(a),a.code.push(k+"=frame.valstack.pop();"),d[f]=k);continue;case 0:d[f]="0";continue;case 1:i=QuoteMem1(b),b++,d[f]=i;continue;case 2:i=QuoteMem2(b),b+=2,d[f]=i;continue;case 3:i=QuoteMem4(b),b+=4,d[f]=i;continue}if(h>=9&&11>=h){if(9==h?(j=Mem1(b),b++):10==h?(j=Mem2(b),b+=2):11==h&&(j=Mem4(b),b+=4),void 0!==a.offloc[j]){d[f]=a.offloc[j];continue}i=4==c.argsize?"frame.locals["+j+"]":2==c.argsize?"frame.locals["+j+"] & 0xffff":"frame.locals["+j+"] & 0xff",k=alloc_holdvar(a,!0),a.code.push(k+"=("+i+");"),a.offloc[j]=k,a.offlocdirty[j]=!1,d[f]=k;continue}switch(h){case 15:j=Mem4(b)+ramstart,b+=4;break;case 14:j=Mem2(b)+ramstart,b+=2;break;case 13:j=Mem1(b)+ramstart,b++;break;case 7:j=Mem4(b),b+=4;break;case 6:j=Mem2(b),b+=2;break;case 5:j=Mem1(b),b++;break;default:fatal_error("Unknown addressing mode in load operand.")}i=4==c.argsize?"Mem4("+j+")":2==c.argsize?"Mem2("+j+")":"Mem1("+j+")",k=alloc_holdvar(a),a.code.push(k+"=("+i+");"),d[f]=k}}return b}function compile_func(a){var b=a,c=Mem1(b);192!=c&&193!=c&&(c>=192&&223>=c?fatal_error("Call to unknown type of function.",b):fatal_error("Call to non-function.",b)),b++;for(var d=[],e=b;;){var f=Mem1(b);b++;var g=Mem1(b);if(b++,0==f)break;1!=f&&2!=f&&4!=f&&fatal_error("Invalid local variable size in function header.",f),d.push({size:f,count:g})}for(var h=memmap.slice(e,b);h.length%4;)h.push(0);return new VMFunc(a,b,d,h)}function compile_path(a,b,c){var d,e,f,g=b,h={vmfunc:a,cp:null,curiosys:c,code:[],holduse:{},varsused:{},offstack:[],offloc:[],offlocdirty:[],path_ends:!1},i={};for(i.func_store={},h.code.push("");!h.path_ends;){e=g,d=Mem1(g),void 0===d&&fatal_error("Tried to compile nonexistent address",g),g++,128&d&&(64&d?(d&=63,d=256*d|Mem1(g),g++,d=256*d|Mem1(g),g++,d=256*d|Mem1(g),g++):(d&=127,d=256*d|Mem1(g),g++)),h.code.push("// "+e.toString(16)+": opcode "+d.toString(16));var j=operandlist_table[d];j||fatal_error("Encountered unknown opcode.",d),g=parse_operands(h,g,j,i),h.cp=g;var k=opcode_table[d];k||fatal_error("Encountered unhandled opcode.",d),k(h,i);for(f in h.holduse)h.holduse[f]===!0&&(h.holduse[f]=!1);h.offstack.length&&h.code.push("// offstack: "+h.offstack.join(",")),h.offloc.length&&h.code.push("// offloc: "+h.offloc.join(",")+"; dirty: "+h.offlocdirty.join(",")),a.pathaddrs[g]&&!h.path_ends&&(h.code.push("// reached jump-in point"),h.code.push("pc="+g+";"),oputil_unload_offstate(h),h.code.push("return;"),h.path_ends=!0)}h.offstack.length&&fatal_error("Path compilation ended with nonempty offstack.",h.offstack.length),h.offloc.length&&fatal_error("Path compilation ended with nonempty offloc.",h.offloc.length);var l=[];for(f in h.holduse)l.push(f);for(f in h.varsused)l.push(f);return l.length&&(h.code[0]="var "+l.join(",")+";"),make_code(h.code.join("\n"))}function enter_function(a,b){var c;total_function_calls++;var d=accel_address_map[a];if(void 0!==d){accel_function_calls++;var e=d(b,tempcallargs);return void pop_callstub(e)}var f=vmfunc_table[a];void 0===f&&(f=compile_func(a),ramstart>a&&(vmfunc_table[a]=f)),pc=f.startpc;var g=new StackFrame(f);if(g.depth=stack.length,g.framestart=0==stack.length?0:frame.framestart+frame.framelen+4*frame.valstack.length,stack.push(g),frame=g,192==f.functype){for(c=b-1;c>=0;c--)frame.valstack.push(tempcallargs[c]);frame.valstack.push(b)}else for(c=0;b>c;c++){var h=f.localsindex[c];if(void 0===h)break;4==h.size?frame.locals[h.pos]=tempcallargs[c]:2==h.size?frame.locals[h.pos]=65535&tempcallargs[c]:1==h.size&&(frame.locals[h.pos]=255&tempcallargs[c])}}function leave_function(){var a=frame.depth;if(stack.pop(),0==stack.length)throw frame=null,ReturnedFromMain;frame=stack[stack.length-1],frame.depth!=a-1&&fatal_error("Stack inconsistent after function exit.")}function pop_stack_to(a){for(;stack.length&&stack[stack.length-1].framestart>a;)stack.pop();0==stack.length&&fatal_error("Stack evaporated during throw."),frame=stack[stack.length-1],a-=frame.framestart+frame.framelen,0>a&&fatal_error("Attempted to throw below the frame value stack."),3&a&&fatal_error("Attempted to throw to an unaligned address."),a>>>=2,a>frame.valstack.length&&fatal_error("Attempted to throw beyond the frame value stack."),frame.valstack.length=a}function pop_callstub(a){var b,c;isNaN(a)&&fatal_error("Function returned undefined value.");var d=frame.valstack.pop();switch(d!=frame.framestart&&fatal_error("Call stub frameptr ("+d+") does not match frame ("+frame.framestart+")"),pc=frame.valstack.pop(),b=frame.valstack.pop(),c=frame.valstack.pop()){case 0:return;case 1:return void MemW4(b,a);case 2:return void(frame.locals[b]=a);case 3:return void frame.valstack.push(a);case 17:return void fatal_error("String-terminator call stub at end of function call.");case 16:return void stream_string(0,pc,225,b);case 18:return void stream_num(0,pc,!0,b);case 19:return void stream_string(0,pc,224,b);case 20:return void stream_string(0,pc,226,b);default:fatal_error("Unrecognized desttype in callstub.",c)}}function store_operand(a,b,c){switch(a){case 0:return;case 1:return void MemW4(b,c);case 2:return void(frame.locals[b]=c);case 3:return void frame.valstack.push(c);default:fatal_error("Unrecognized desttype in callstub.",a)}}function store_operand_by_funcop(a,b){if(a)switch(a.mode){case 8:return void frame.valstack.push(b);case 0:return;case 11:return void(frame.locals[a.addr]=4==a.argsize?b:2==a.argsize?65535&b:255&b);case 15:return void(4==a.argsize?MemW4(a.addr,b):2==a.argsize?MemW2(a.addr,b):MemW1(a.addr,b));default:fatal_error("Unknown addressing mode in store func by operand.")}}function set_random(a){0==a?random_func=Math.random:(srand_set_seed(a),random_func=srand_get_random)}function srand_set_seed(a){var b,c,d,e,f;for(void 0===srand_table&&(srand_table=Array(55)),srand_table[54]=a,srand_index1=0,srand_index2=31,d=1,b=0;55>b;b++)c=21*b%55,srand_table[c]=d,d=a-d>>>0,a=srand_table[c];for(f=0;4>f;f++)for(b=0;55>b;b++)e=srand_table[b]-srand_table[(1+b+30)%55],srand_table[b]=e>>>0}function srand_get_random(){return srand_index1=(srand_index1+1)%55,srand_index2=(srand_index2+1)%55,srand_table[srand_index1]=srand_table[srand_index1]-srand_table[srand_index2]>>>0,srand_table[srand_index1]/4294967296}function accel_helper_obj_in_class(a){return Mem4(a+13+accel_params[7])==accel_params[2]}function accel_helper_get_prop(a,b){var c,d=0;if(4294901760&b){if(d=Mem4(accel_params[0]+4*(65535&b)),accel_helper_temp_args[0]=a,accel_helper_temp_args[1]=d,0==accel_func_map[5](2,accel_helper_temp_args))return 0;b>>=16,a=d}return accel_helper_temp_args[0]=a,accel_helper_temp_args[1]=b,c=accel_func_map[2](2,accel_helper_temp_args),0==c?0:accel_helper_obj_in_class(a)&&0==d&&(b<accel_params[1]||b>=accel_params[1]+8)?0:Mem4(accel_params[6])!=a&&1&Mem1(c+9)?0:c}function set_string_table(a){if(stringtable!=a&&(decoding_tree=void 0,vmstring_table=void 0,stringtable=a,0!=stringtable)){var b=vmtextenv_table[stringtable];if(void 0===b){var c=void 0,d=Mem4(stringtable),e=Mem4(stringtable+8),f=ramstart>=stringtable+d;if(f){var g=Array(1);build_decoding_tree(g,e,4,0),c=g[0],void 0===c&&fatal_error("Failed to create decoding tree.")}b=new VMTextEnv(stringtable,c),vmtextenv_table[stringtable]=b}decoding_tree=b.decoding_tree,vmstring_table=b.vmstring_tables[iosysmode]}}function set_iosys(a,b){switch(a){case 0:b=0;break;case 1:break;case 2:b=0;break;default:a=0,b=0}iosysmode=a,iosysrock=b;var c=vmtextenv_table[stringtable];vmstring_table=void 0===c?void 0:c.vmstring_tables[iosysmode]}function build_decoding_tree(a,b,c,d){var e,f,g,h;if(f=Mem1(b),0==f&&4==c)return g=Array(16),g.type=0,g.depth=4,a[d]=g,void build_decoding_tree(g,b,0,0);if(0==f){var i=Mem4(b+1),j=Mem4(b+5);return build_decoding_tree(a,i,c+1,d),void build_decoding_tree(a,j,c+1,d|1<<c)}switch(b++,g={},g.type=f,g.depth=c,f){case 2:g.value=Mem1(b),g.cchar=CharToString(g.value);break;case 4:g.value=Mem4(b),g.cchar=CharToString(g.value);break;case 3:case 5:g.addr=b;break;case 8:case 9:g.addr=Mem4(b);break;case 10:case 11:g.addr=b;break;case 1:break;default:fatal_error("Unknown node type in string table.",f)}for(h=1<<c,e=d;16>e;e+=h)a[e]=g}function stream_num(a,b,c,d){var e=(4294967295&b).toString(10);switch(iosysmode){case 2:d&&(e=e.slice(d)),Glk.glk_put_jstring(e,!0);break;case 1:if(c||(frame.valstack.push(17,0,a,frame.framestart),c=!0),d<e.length){var f=e.charCodeAt(d);return frame.valstack.push(18,d+1,b,frame.framestart),tempcallargs[0]=f,enter_function(iosysrock,1),!0}break;case 0:}if(c){var g,h;frame.valstack.pop()!=frame.framestart&&fatal_error("Call stub frameptr does not match frame."),pc=frame.valstack.pop(),h=frame.valstack.pop(),g=frame.valstack.pop(),17!=g&&fatal_error("String-on-string call stub while printing number.")}}function stream_string(a,b,c,d){for(var e,f,g,h,i,j=0!=c;;){if(f=void 0,e=0==c?b:b+"/"+c+"/"+d,void 0!==vmstring_table?(f=vmstring_table[e],void 0===f&&(f=compile_string(iosysmode,b,c,d),vmstring_table[e]=f,strings_compiled++,strings_cached++)):(f=compile_string(iosysmode,b,c,d),strings_compiled++),f instanceof Function){if(g=f(a,j),g instanceof Array){j=!0,b=g[0],c=g[1],d=g[2];continue}if(g)return!0}else if(Glk.glk_put_jstring(f),!j)return!1;if(frame.valstack.pop()!=frame.framestart&&fatal_error("Call stub frameptr does not match frame."),pc=frame.valstack.pop(),i=frame.valstack.pop(),h=frame.valstack.pop(),17==h)return!0;16==h?(j=!0,d=i,c=225,b=pc):fatal_error("Function-terminator call stub at end of string.")}}function compile_string(a,b,c,d){var e,f,g=b,h=d,i=void 0;g||fatal_error("Called compile_string with null address.");var j={startaddr:b,startbitnum:d,buffer:[],code:[]};if(0==c?(f=Mem1(g),226==f?g+=4:g++,h=0):f=c,225==f)if(decoding_tree){var k,l,m,n,o,p,q=!1;for(k=Mem1(g),h&&(k>>=h),l=8-h,m=!1,decoding_tree instanceof Array||(q=!0),o=decoding_tree;!q;){if(4>l){var r=Mem1(g+1);k|=r<<l,l+=8,m=!0}if(p=o[15&k],l-=p.depth,k>>=p.depth,h+=p.depth,h>=8)if(g+=1,h-=8,m)m=!1;else{var r=Mem1(g);k|=r<<l,l+=8}if(p instanceof Array)o=p;else switch(p.type){case 1:q=!0;break;case 2:case 4:switch(a){case 2:j.buffer.push(p.cchar);break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),j.code.push("tempcallargs[0]="+p.value+";"),j.code.push("enter_function(iosysrock, 1);"),i=!0,q=!0}o=decoding_tree;break;case 3:switch(a){case 2:for(n=p.addr;;){if(e=Mem1(n),0==e)break;j.buffer.push(CharToString(e)),n++}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),i="["+p.addr+", 0xE0, 0]",q=!0}o=decoding_tree;break;case 5:switch(a){case 2:for(n=p.addr;;){if(e=Mem4(n),0==e)break;j.buffer.push(CharToString(e)),n+=4}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),i="["+p.addr+", 0xE2, 0]",q=!0}o=decoding_tree;break;case 8:case 9:case 10:case 11:oputil_flush_string(j),oputil_push_substring_callstub(j),j.code.push("var otype, retval;"),j.code.push("var oaddr = "+p.addr+";"),p.type>=9&&j.code.push("oaddr = Mem4(oaddr);"),11==p.type&&j.code.push("oaddr = Mem4(oaddr);"),j.code.push("otype = Mem1(oaddr);"),i="retval",q=!0,oputil_push_callstub(j,"0x10,"+h,g),j.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),j.code.push("retval = [oaddr, 0, 0];"),j.code.push("}"),j.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var s=0;if(10==p.type||11==p.type){s=Mem4(p.addr+4);for(var t=0;s>t;t++)j.code.push("tempcallargs["+t+"]="+Mem4(p.addr+8+4*t)+";")}j.code.push("enter_function(oaddr, "+s+");"),j.code.push("retval = true;"),j.code.push("}"),j.code.push("else {"),j.code.push("fatal_error('Unknown object while decoding string indirect reference.', otype);"),j.code.push("}");break;default:fatal_error("Unknown entity in string decoding (cached).")}}}else{var u,v,w,q=!1;for(stringtable||fatal_error("Attempted to print a compressed string with no table set."),v=Mem1(g),h&&(v>>=h),u=Mem4(stringtable+8);!q;)switch(w=Mem1(u),u++,w){case 0:u=Mem4(1&v?u+4:u+0),7==h?(h=0,g++,v=Mem1(g)):(h++,v>>=1);break;case 1:i=!1,q=!0;break;case 2:switch(e=Mem1(u),a){case 2:j.buffer.push(CharToString(e));break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),j.code.push("tempcallargs[0]="+e+";"),j.code.push("enter_function(iosysrock, 1);"),i=!0,q=!0}u=Mem4(stringtable+8);break;case 4:switch(e=Mem4(u),a){case 2:j.buffer.push(CharToString(e));break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),j.code.push("tempcallargs[0]="+e+";"),j.code.push("enter_function(iosysrock, 1);"),i=!0,q=!0}u=Mem4(stringtable+8);break;case 3:switch(a){case 2:for(;;){if(e=Mem1(u),0==e)break;j.buffer.push(CharToString(e)),u++}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),i="["+u+", 0xE0, 0]",q=!0}u=Mem4(stringtable+8);break;case 5:switch(a){case 2:for(;;){if(e=Mem4(u),0==e)break;j.buffer.push(CharToString(e)),u+=4}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),oputil_push_callstub(j,"0x10,"+h,g),i="["+u+", 0xE2, 0]",q=!0}u=Mem4(stringtable+8);break;case 8:case 9:case 10:case 11:oputil_flush_string(j),oputil_push_substring_callstub(j),j.code.push("var otype, retval;"),j.code.push("var oaddr = "+Mem4(u)+";"),(9==w||11==w)&&j.code.push("oaddr = Mem4(oaddr);"),j.code.push("otype = Mem1(oaddr);"),i="retval",q=!0,oputil_push_callstub(j,"0x10,"+h,g),j.code.push("if (otype >= 0xE0 && otype <= 0xFF) {"),j.code.push("retval = [oaddr, 0, 0];"),j.code.push("}"),j.code.push("else if (otype >= 0xC0 && otype <= 0xDF) {");var s=0;if(10==w||11==w){s=Mem4(u+4);for(var t=0;s>t;t++)j.code.push("tempcallargs["+t+"]="+Mem4(u+8+4*t)+";")}j.code.push("enter_function(oaddr, "+s+");"),j.code.push("retval = true;"),j.code.push("}"),j.code.push("else {"),j.code.push("fatal_error('Unknown object while decoding string indirect reference.', otype);"),j.code.push("}");break;default:fatal_error("Unknown entity in string decoding.",w)}}else if(224==f){var e;switch(a){case 2:for(;;){if(e=Mem1(g),g++,0==e)break;j.buffer.push(CharToString(e))}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),e=Mem1(g),g++,0!=e?(oputil_push_callstub(j,"0x13,0",g),j.code.push("tempcallargs[0]="+e+";"),j.code.push("enter_function(iosysrock, 1);"),i=!0):i="false"}}else if(226==f){var e;switch(a){case 2:for(;;){if(e=Mem4(g),g+=4,0==e)break;j.buffer.push(CharToString(e))}break;case 1:oputil_flush_string(j),oputil_push_substring_callstub(j),e=Mem4(g),g+=4,0!=e?(oputil_push_callstub(j,"0x14,0",g),j.code.push("tempcallargs[0]="+e+";"),j.code.push("enter_function(iosysrock, 1);"),i=!0):i="false"}}else fatal_error(f>=224&&255>=f?"Attempt to print unknown type of string.":"Attempt to print non-string.");return i?(oputil_flush_string(j),j.code.push("return "+i+";"),make_code(j.code.join("\n"),"nextcp,substring")):(j.code.length&&fatal_error("Simple-case string generated code."),j.buffer.join(""))}function do_gestalt(a,b){switch(a){case 0:return 196866;case 1:return 65793;case 2:return 1;case 3:return 1;case 4:switch(b){case 0:return 1;case 1:return 1;case 2:return 1;default:return 0}break;case 5:return 1;case 6:return 1;case 7:return 1;case 8:return heap_get_start();case 9:return 1;case 10:return accel_func_map[b]?1:0;case 11:return 1;default:return 0}}function fetch_search_key(a,b,c){var d;if(tempsearchkey.length=b,1&c)for(d=0;b>d;d++)tempsearchkey[d]=Mem1(a+d);else switch(b){case 4:tempsearchkey[0]=a>>24&255,tempsearchkey[1]=a>>16&255,tempsearchkey[2]=a>>8&255,tempsearchkey[3]=255&a;break;case 2:tempsearchkey[0]=a>>8&255,tempsearchkey[1]=255&a;break;case 1:tempsearchkey[0]=255&a;break;default:throw"Direct search key must hold one, two, or four bytes."}return tempsearchkey}function linear_search(a,b,c,d,e,f,g){var h,i,j,k,l=0!=(4&g),m=0!=(2&g),n=fetch_search_key(a,b,g);

for(i=0;e>i;i++,c+=d){for(j=!0,h=0;j&&b>h;h++)k=Mem1(c+f+h),k!=n[h]&&(j=!1);if(j)return l?i:c;if(m){for(j=!0,h=0;j&&b>h;h++)k=Mem1(c+f+h),0!=k&&(j=!1);if(j)break}}return l?4294967295:0}function binary_search(a,b,c,d,e,f,g){var h,i,j,k,l,m,n,o,p=0!=(4&g),q=fetch_search_key(a,b,g);for(i=0,h=e;h>i;){for(l=0,k=h+i>>1,j=c+k*d,m=0;!l&&b>m;m++)n=Mem1(j+f+m),o=q[m],o>n?l=-1:n>o&&(l=1);if(!l)return p?k:j;0>l?i=k+1:h=k}return p?4294967295:0}function linked_search(a,b,c,d,e,f){for(var g,h,i,j=0!=(2&f),k=fetch_search_key(a,b,f);0!=c;){for(i=!0,g=0;i&&b>g;g++)h=Mem1(c+d+g),h!=k[g]&&(i=!1);if(i)return c;if(j){for(i=!0,g=0;i&&b>g;g++)h=Mem1(c+d+g),0!=h&&(i=!1);if(i)break}c=Mem4(c+e)}return 0}function decode_float(a){var b,c,d;return 2147483648&a?(b=!0,a=2147483647&a):b=!1,0==a?b?-0:0:2139095040==(2139095040&a)?0==(8388607&a)?b?-(1/0):1/0:b?0/0:0/0:(d=a>>23&255,c=d?(8388607&a|8388608)/8388608*Math.pow(2,d-127):(8388607&a)/8388608*Math.pow(2,-126),b?-c:c)}function encode_float(a){var b,c,d,e,f;return isNaN(a)?2139095041:isFinite(a)?0==a?0>1/a?2147483648:0:(0>a?(f=!0,b=-a):(f=!1,b=a),e=Math.floor(Math.log(b)/Math.log(2)),d=b/Math.pow(2,e),e>=128?f?4286578688:2139095040:(-126>e?(d*=Math.pow(2,126+e),e=0):(0!=e||0!=d)&&(e+=127,d-=1),d=8388608*d,c=d+.4999999999999999<<0,c>=8388608&&(c=0,e++,e>=255)?f?4286578688:2139095040:f?(2147483648|e<<23|c)>>>0:e<<23|c)):0>a?4286578688:2139095040}function setup_vm(){var a,b;game_image||fatal_error("There is no Glulx game file loaded."),vm_started=!0,resumefuncop=null,resumevalue=0,memmap=null,stack=[],frame=null,pc=0,game_image.length<36&&fatal_error("This is too short to be a valid Glulx file."),a=ByteRead4(game_image,0),1198290284!=a&&fatal_error("This is not a valid Glulx file."),b=ByteRead4(game_image,4),131072>b&&fatal_error("This Glulx file is too old a version to execute."),b>=197120&&fatal_error("This Glulx file is too new a version to execute."),ramstart=ByteRead4(game_image,8),endgamefile=ByteRead4(game_image,12),origendmem=ByteRead4(game_image,16),stacksize=ByteRead4(game_image,20),startfuncaddr=ByteRead4(game_image,24),origstringtable=ByteRead4(game_image,28),checksum=ByteRead4(game_image,32),protectstart=0,protectend=0,(256>ramstart||ramstart>endgamefile||endgamefile>origendmem)&&fatal_error("The segment boundaries in the header are in an impossible order."),endgamefile!=game_image.length&&fatal_error("The game file length does not agree with the header."),done_executing=!1,vmfunc_table={},vmtextenv_table={},decoding_tree=void 0,vmstring_table=void 0,tempcallargs=Array(8),tempglkargs=Array(1),set_random(0),endmem=origendmem,stringtable=0,undostack=[],heapstart=0,usedlist=[],freelist=[],vm_restart()}function vm_restart(){heap_clear();var a=copy_protected_range();memmap=null,memmap=game_image.slice(0,endgamefile),endmem=memmap.length,change_memsize(origendmem,!1),paste_protected_range(a),stack=[],frame=null,pc=0,iosysmode=0,iosysrock=0,set_string_table(origstringtable),enter_function(startfuncaddr,0)}function compress_bytes(a){result=[];for(var b=0;b<a.length;){for(var c=0;b<a.length&&0==a[b]&&255>=c;)c++,b++;for(c>0&&(result.push(0),result.push(c-1));b<a.length&&0!=a[b];)result.push(a[b]),b++}return result}function decompress_bytes(a){result=[];for(var b=0;b<a.length;){var c=a[b++];if(0==c)for(var d=a[b++]+1,e=0;d>e;e++)result.push(0);else result.push(c)}return result}function pack_iff_chunks(a){keys=[];for(var b in a)4!=b.length&&fatal_error("Bad chunk ID (must be exactly 4 chars): "+b),keys.push(b);keys.sort(),bytes=[];for(var c=0;c<keys.length;c++){var b=keys[c],d=a[b];BytePushString(bytes,b),BytePush4(bytes,d.length),bytes=bytes.concat(d)}return bytes}function unpack_iff_chunks(a){chunks={};for(var b=0;b<a.length;){if(b+8>a.length)return void qlog("IFF chunk header is truncated");var c=ByteReadString(a,b,4),d=ByteRead4(a,b+4);if(b+=8,b+d>a.length)return void qlog(c+" chunk is truncated ("+d+" bytes needed, "+(a.length-b)+" available");chunks[c]=a.slice(b,b+d),b+=d}return chunks}function vm_save(a){memmap.length!=endmem&&fatal_error("Memory length was incorrect before save."),2!=iosysmode&&fatal_error("Streams are only available in Glk I/O system.");var b=GiDispa.class_obj_from_id("stream",a);if(!b)return!1;chunks={},chunks.IFhd=game_image.slice(0,128),chunks.CMem=memmap.slice(ramstart);for(var c=ramstart;c<game_image.length;c++)chunks.CMem[c-ramstart]^=game_image[c];chunks.CMem=compress_bytes(chunks.CMem),chunks.QFun=[];for(var c=0;c<stack.length;c++)BytePush4(chunks.QFun,stack[c].vmfunc.funcaddr);chunks.Stks=[];for(var c=0;c<stack.length;c++)push_serialized_stackframe(stack[c],chunks.Stks);if(heap_is_active()){chunks.MAll=[],BytePush4(chunks.MAll,heapstart),BytePush4(chunks.MAll,usedlist.length);for(var c=0;c<usedlist.length;c++)BytePush4(chunks.MAll,usedlist[c].addr),BytePush4(chunks.MAll,usedlist[c].size)}var d=[];BytePushString(d,"IFZS"),d=d.concat(pack_iff_chunks(chunks));var e=pack_iff_chunks({FORM:d});return Glk.glk_put_buffer_stream(b,e),!0}function vm_restore(a){2!=iosysmode&&fatal_error("Streams are only available in Glk I/O system.");var b=GiDispa.class_obj_from_id("stream",a);if(!b)return!1;for(var c=new Array(0),d=new Array(1024),e=1;e>0;)e=Glk.glk_get_buffer_stream(b,d),c=c.concat(d.slice(0,e));if(c=unpack_iff_chunks(c),!c)return qlog("vm_restore failed: file is not Quetzal"),!1;if(c=c.FORM,!c||"IFZS"!=ByteReadString(c,0,4))return qlog("vm_restore failed: file doesn't start with FORM/IFZS header"),!1;var f=unpack_iff_chunks(c.slice(4));if(!f.IFhd)return qlog("vm_restore failed: missing required IFhd chunk"),!1;for(var g=0;128>g;g++)if(f.IFhd[g]!=game_image[g])return qlog("vm_restore failed: this save image is for a different game"),!1;if(!f.CMem)return qlog("vm_restore failed: missing required CMem chunk"),!1;f.QFun||qlog("vm_restore failed: missing required QFun chunk"),f.Stks||qlog("vm_restore failed: missing required Stks chunk");var h=copy_protected_range();heap_clear();var i=decompress_bytes(f.CMem);change_memsize(ramstart+i.length,!1),memmap=game_image.slice(0,ramstart).concat(i);for(var g=ramstart;g<game_image.length;g++)memmap[g]^=game_image[g];for(var j=[],k=0;k<f.QFun.length;k+=4){var l=ByteRead4(f.QFun,k),m=vmfunc_table[l];void 0===m&&(m=compile_func(l),ramstart>l&&(vmfunc_table[l]=m)),j.push(m)}stack=[];for(var g=j.length-1;g>=0;g--)frame=pop_deserialized_stackframe(f.Stks,j[g]),frame||fatal_error("vm_restore failed: bad stack frame"),stack.unshift(frame);for(var g=0;g<stack.length;g++)stack[g].depth=g;if(frame=stack[stack.length-1],f.MAll){heapstart=ByteRead4(f.MAll,0);for(var n=ByteRead4(f.MAll,4),o=heapstart,g=0;n>g;g++){var l=ByteRead4(f.MAll,8+4*g),p=ByteRead4(f.MAll,12+4*g);(o>l||l+p>endmem)&&fatal_error("vm_restore failed: corrupt dynamic heap"),usedlist.push(new HeapBlock(l,p)),l>o&&freelist.push(new HeapBlock(o,l-o)),o=l+p}endmem>o&&freelist.push(new HeapBlock(o,endmem-o))}return paste_protected_range(h),!0}function vm_saveundo(){memmap.length!=endmem&&fatal_error("Memory length was incorrect before saveundo.");var a={};a.ram=memmap.slice(ramstart),a.endmem=endmem,a.pc=pc,a.stack=[];for(var b=0;b<stack.length;b++)a.stack[b]=clone_stackframe(stack[b]);a.heapstart=heapstart,a.usedlist=usedlist.slice(0),a.freelist=freelist.slice(0),undostack.push(a),undostack.length>10&&undostack.shift()}function vm_restoreundo(){if(0==undostack.length)return!1;var a=undostack.pop(),b=copy_protected_range();return memmap=memmap.slice(0,ramstart).concat(a.ram),endmem=a.endmem,stack=a.stack,frame=stack[stack.length-1],pc=a.pc,heapstart=a.heapstart,usedlist=a.usedlist,freelist=a.freelist,paste_protected_range(b),memmap.length!=endmem&&fatal_error("Memory length was incorrect after undo."),!0}function change_memsize(a,b){var c;if(a!=endmem){if(!b&&heap_is_active()&&fatal_error("Cannot resize Glulx memory space while heap is active."),origendmem>a&&fatal_error("Cannot resize Glulx memory space smaller than it started."),255&a&&fatal_error("Can only resize Glulx memory space to a 256-byte boundary."),memmap.length=a,a>endmem)for(c=endmem;a>c;c++)memmap[c]=0;endmem=a}}function copy_protected_range(){if(protectstart>=protectend)return null;for(var a=protectend-protectstart,b={start:protectstart,end:protectend,len:a},c=memmap.slice(protectstart,protectend);c.length<a;)c.push(0);return b.mem=c,b}function paste_protected_range(a){if(a){var b,c,d=a.mem,e=a.start,f=a.end;for(f>endmem&&(f=endmem),b=0,c=e;f>c;b++,c++)memmap[c]=d[b]}}function perform_verify(){var a,b,c,d=game_image.length;if(256>d||0!=(255&d))return 1;if(d!=ByteRead4(game_image,12))return 1;for(c=ByteRead4(game_image,32),b=-c>>>0,a=0;d>a;a+=4)b=b+ByteRead4(game_image,a)>>>0;return b!=c?1:0}function quixe_get_signature(){return game_signature}function quixe_get_statistics(){var a={game_image_length:game_image.length,total_execution_time:total_execution_time,total_function_calls:total_function_calls,accel_function_calls:accel_function_calls,total_path_calls:total_path_calls,paths_cached:paths_cached,paths_compiled:paths_compiled,strings_cached:strings_cached,strings_compiled:strings_compiled};return a}function heap_clear(){heapstart=0,usedlist=[],freelist=[]}function heap_is_active(){return usedlist.length>0}function heap_get_start(){return heapstart}function HeapBlock(a,b){this.addr=a,this.size=b,this.end=a+b}function heap_binary_search(a,b){for(var c=0,d=a.length;d>c;){var e=c+d>>1;a[e].addr<b?c=e+1:d=e}return c}function heap_malloc(a){heap_is_active()||(heapstart=endmem);for(var b=0,c=freelist.length;c>b;b++){var d=freelist[b];if(d.size>=a){d.size>a?freelist[b]=new HeapBlock(d.addr+a,d.size-a):freelist.splice(b,1);var e=heap_binary_search(usedlist,d.addr);return usedlist.splice(e,0,new HeapBlock(d.addr,a)),d.addr}}var f=endmem,g=a+255&4294967040;return change_memsize(endmem+g,!0),g>a&&freelist.push(new HeapBlock(f+a,g-a)),usedlist.push(new HeapBlock(f,a)),f}function heap_free(a){var b=heap_binary_search(usedlist,a),c=usedlist[b];if(c&&c.addr==a||fatal_error("Tried to free non-existent block"),usedlist.splice(b,1),0==usedlist.length)return change_memsize(heapstart,!0),void heap_clear();b=heap_binary_search(freelist,a);var d=freelist[b];d&&d.addr==c.end&&(c=new HeapBlock(a,c.size+d.size),freelist.splice(b,1));var e=freelist[b-1];e&&e.end==c.addr&&(c=new HeapBlock(e.addr,e.size+c.size),freelist.splice(b-1,1),b-=1),freelist.splice(b,0,c)}function assert_heap_valid(){if(!heap_is_active())return 0!=heapstart&&fatal_error("Heap inconsistency: heapstart nonzero"),usedlist.length>0&&fatal_error("Heap inconsistency: usedlist nonempty"),void(freelist.length>0&&fatal_error("Heap inconsistency: usedlist nonempty"));0==heapstart&&fatal_error("Heap inconsistency: heapstart is zero");for(var a=heapstart,b=0,c=0;b<usedlist.length||c<freelist.length;){var d=usedlist[b],e=freelist[c];d&&d.addr==a?(a+=d.size,b++):e&&e.addr==a?(a+=e.size,c++):fatal_error("Heap inconsistency: no block at address "+a)}a!=endmem&&fatal_error("Heap inconsistency: overrun at end of heap")}function execute_loop(){var a,b,c,d,e;for(resumefuncop&&(store_operand_by_funcop(resumefuncop,resumevalue),resumefuncop=null,resumevalue=0),d=(new Date).getTime();!done_executing;){a=frame.vmfunc,b=a[iosysmode],c=b[pc],void 0===c&&(a.pathaddrs[pc]=!0,c=compile_path(a,pc,iosysmode),paths_compiled++,ramstart>pc&&(b[pc]=c,paths_cached++)),total_path_calls++;try{c()}catch(f){if(f!==ReturnedFromMain)throw f;done_executing=!0,vm_stopped=!0}}e=(new Date).getTime(),total_execution_time+=(e-d)/1e3,vm_stopped&&Glk.glk_exit(),Glk.update(),qlog("### done executing; path time = "+(e-d)+" ms")}var bytestring_table=Array(256),quotechar_table=Array(256),regexp_string_unsafe=/[^a-zA-Z0-9 .,;:?!=_+()-]/g,operandlist_table=null,funcop_cache={},opcode_table={0:function(a,b){},16:function(a,b){a.code.push(b[2]+"(("+b[0]+")+("+b[1]+")) >>>0);")},17:function(a,b){a.code.push(b[2]+"(("+b[0]+")-("+b[1]+")) >>>0);")},18:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]);a.code.push(b[2]+"(("+c+")*("+d+")) >>>0);")},19:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]),e=alloc_holdvar(a);a.code.push(e+"=(("+c+")/("+d+"));"),a.code.push("if (!isFinite("+e+")) fatal_error('Division by zero.');"),a.code.push(b[2]+"("+e+">=0)?Math.floor("+e+"):(-Math.floor(-"+e+") >>>0));")},20:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]),e=alloc_holdvar(a);a.code.push(e+"=(("+c+")%("+d+"));"),a.code.push("if (!isFinite("+e+")) fatal_error('Modulo division by zero.');"),a.code.push(b[2]+e+" >>>0);")},21:function(a,b){a.code.push(b[1]+"(-("+b[0]+")) >>>0);")},24:function(a,b){a.code.push(b[2]+"(("+b[0]+")&("+b[1]+")) >>>0);")},25:function(a,b){a.code.push(b[2]+"(("+b[0]+")|("+b[1]+")) >>>0);")},26:function(a,b){a.code.push(b[2]+"(("+b[0]+")^("+b[1]+")) >>>0);")},27:function(a,b){a.code.push(b[1]+"(~("+b[0]+")) >>>0);")},28:function(a,b){if(quot_isconstant(b[1])){var c=Number(b[1]);a.code.push(32>c?b[2]+"(("+b[0]+")<<"+c+") >>>0);":b[2]+"0);")}else a.code.push(b[2]+"("+b[1]+"<32) ? (("+b[0]+"<<"+b[1]+") >>>0) : 0);")},29:function(a,b){if(quot_isconstant(b[1])){var c=Number(b[1]);a.code.push(32>c?b[2]+"(("+b[0]+")>>"+c+") >>>0);":b[2]+"(("+b[0]+")&0x80000000) ? 0xffffffff : 0);")}else a.code.push("if ("+b[0]+" & 0x80000000) {"),a.code.push(b[2]+"("+b[1]+"<32) ? (("+b[0]+">>"+b[1]+") >>>0) : 0xffffffff);"),a.code.push("} else {"),a.code.push(b[2]+"("+b[1]+"<32) ? (("+b[0]+">>"+b[1]+") >>>0) : 0);"),a.code.push("}")},30:function(a,b){if(quot_isconstant(b[1])){var c=Number(b[1]);a.code.push(32>c?b[2]+"("+b[0]+")>>>"+c+");":b[2]+"0);")}else a.code.push(b[2]+"("+b[1]+"<32) ? ("+b[0]+">>>"+b[1]+") : 0);")},32:function(a,b){oputil_perform_jump(a,b[0],!0),a.path_ends=!0},260:function(a,b){if(quot_isconstant(b[0])){var c=Number(b[0]);a.code.push("pc = "+c+";"),a.vmfunc.pathaddrs[c]=!0}else a.code.push("pc = "+b[0]+";");oputil_unload_offstate(a),a.code.push("return;"),a.path_ends=!0},34:function(a,b){a.code.push("if (("+b[0]+")==0) {"),oputil_perform_jump(a,b[1]),a.code.push("}")},35:function(a,b){a.code.push("if (("+b[0]+")!=0) {"),oputil_perform_jump(a,b[1]),a.code.push("}")},36:function(a,b){a.code.push("if (("+b[0]+")==("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},37:function(a,b){a.code.push("if (("+b[0]+")!=("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},38:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]);a.code.push("if (("+c+")<("+d+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},39:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]);a.code.push("if (("+c+")>=("+d+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},40:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]);a.code.push("if (("+c+")>("+d+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},41:function(a,b){var c=oputil_signify_operand(a,b[0]),d=oputil_signify_operand(a,b[1]);a.code.push("if (("+c+")<=("+d+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},42:function(a,b){a.code.push("if (("+b[0]+")<("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},43:function(a,b){a.code.push("if (("+b[0]+")>=("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},44:function(a,b){a.code.push("if (("+b[0]+")>("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},45:function(a,b){a.code.push("if (("+b[0]+")<=("+b[1]+")) {"),oputil_perform_jump(a,b[2]),a.code.push("}")},48:function(a,b){if(quot_isconstant(b[1])){var c,d=Number(b[1]);for(c=0;d>c;c++)if(a.offstack.length){var e=pop_offstack_holdvar(a);a.code.push("tempcallargs["+c+"]="+e+";")}else a.code.push("tempcallargs["+c+"]=frame.valstack.pop();");oputil_unload_offstate(a)}else a.varsused.ix=!0,oputil_unload_offstate(a),a.code.push("for (ix=0; ix<"+b[1]+"; ix++) { tempcallargs[ix]=frame.valstack.pop(); }");oputil_push_callstub(a,b[2]),a.code.push("enter_function("+b[0]+", "+b[1]+");"),a.code.push("return;"),a.path_ends=!0},52:function(a,b){if(quot_isconstant(b[1])){var c,d=Number(b[1]);for(c=0;d>c;c++)if(a.offstack.length){var e=pop_offstack_holdvar(a);a.code.push("tempcallargs["+c+"]="+e+";")}else a.code.push("tempcallargs["+c+"]=frame.valstack.pop();");oputil_unload_offstate(a)}else a.varsused.ix=!0,oputil_unload_offstate(a),a.code.push("for (ix=0; ix<"+b[1]+"; ix++) { tempcallargs[ix]=frame.valstack.pop(); }");a.code.push("leave_function();"),a.code.push("enter_function("+b[0]+", "+b[1]+");"),a.code.push("return;"),a.path_ends=!0},352:function(a,b){oputil_unload_offstate(a),oputil_push_callstub(a,b[1]),a.code.push("enter_function("+b[0]+", 0);"),a.code.push("return;"),a.path_ends=!0},353:function(a,b){oputil_unload_offstate(a),a.code.push("tempcallargs[0]=("+b[1]+");"),oputil_push_callstub(a,b[2]),a.code.push("enter_function("+b[0]+", 1);"),a.code.push("return;"),a.path_ends=!0},354:function(a,b){oputil_unload_offstate(a),a.code.push("tempcallargs[0]=("+b[1]+");"),a.code.push("tempcallargs[1]=("+b[2]+");"),oputil_push_callstub(a,b[3]),a.code.push("enter_function("+b[0]+", 2);"),a.code.push("return;"),a.path_ends=!0},355:function(a,b){oputil_unload_offstate(a),a.code.push("tempcallargs[0]=("+b[1]+");"),a.code.push("tempcallargs[1]=("+b[2]+");"),a.code.push("tempcallargs[2]=("+b[3]+");"),oputil_push_callstub(a,b[4]),a.code.push("enter_function("+b[0]+", 3);"),a.code.push("return;"),a.path_ends=!0},49:function(a,b){a.code.push("// quashing offstack for return: "+a.offstack.length),a.offstack.length=0,a.offloc.length=0,a.offlocdirty.length=0,a.code.push("leave_function();"),a.code.push("pop_callstub("+b[0]+");"),a.code.push("return;"),a.path_ends=!0},50:function(a,b){oputil_unload_offstate(a),oputil_push_callstub(a,b[0]),a.code.push("store_operand("+b[0]+",frame.framestart+frame.framelen+4*frame.valstack.length);"),oputil_perform_jump(a,b[1],!0),a.path_ends=!0},51:function(a,b){a.code.push("// quashing offstack for throw: "+a.offstack.length),a.offstack.length=0,a.offloc.length=0,a.offlocdirty.length=0,a.code.push("pop_stack_to("+b[1]+");"),a.code.push("pop_callstub("+b[0]+");"),a.code.push("return;"),a.path_ends=!0},64:function(a,b){oputil_store(a,b[1],b[0])},65:function(a,b){oputil_store(a,b[1],b[0])},66:function(a,b){oputil_store(a,b[1],b[0])},68:function(a,b){var c;quot_isconstant(b[0])?(c=Number(b[0]),c=32768&c?(4294901760|c)>>>0:65535&c,a.code.push(b[1]+c+");")):a.code.push(b[1]+"("+b[0]+" & 0x8000) ? (("+b[0]+" | 0xffff0000) >>> 0) : ("+b[0]+" & 0xffff));")},69:function(a,b){var c;quot_isconstant(b[0])?(c=Number(b[0]),c=128&c?(4294967040|c)>>>0:255&c,a.code.push(b[1]+c+");")):a.code.push(b[1]+"("+b[0]+" & 0x80) ? (("+b[0]+" | 0xffffff00) >>> 0) : ("+b[0]+" & 0xff));")},72:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+4*Number(b[1]),c="Mem4("+(d>>>0)+")";else{var d=4*Number(b[1]);c=d?"Mem4(("+b[0]+"+"+d+") >>>0)":"Mem4("+b[0]+")"}else c="Mem4(("+b[0]+"+4*"+b[1]+") >>>0)";a.code.push(b[2]+c+");")},73:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+2*Number(b[1]),c="Mem2("+(d>>>0)+")";else{var d=2*Number(b[1]);c=d?"Mem2(("+b[0]+"+"+d+") >>>0)":"Mem2("+b[0]+")"}else c="Mem2(("+b[0]+"+2*"+b[1]+") >>>0)";a.code.push(b[2]+c+");")},74:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+Number(b[1]),c="Mem1("+(d>>>0)+")";else{var d=Number(b[1]);c=d?"Mem1(("+b[0]+"+"+d+") >>>0)":"Mem1("+b[0]+")"}else c="Mem1(("+b[0]+"+"+b[1]+") >>>0)";a.code.push(b[2]+c+");")},76:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+4*Number(b[1]),c=(d>>>0)+",";else{var d=4*Number(b[1]);c=d?"("+b[0]+"+"+d+") >>>0,":b[0]+","}else c="("+b[0]+"+4*"+b[1]+") >>>0,";a.code.push("MemW4("+c+b[2]+");")},77:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+2*Number(b[1]),c=(d>>>0)+",";else{var d=2*Number(b[1]);c=d?"("+b[0]+"+"+d+") >>>0,":b[0]+","}else c="("+b[0]+"+2*"+b[1]+") >>>0,";a.code.push("MemW2("+c+b[2]+");")},78:function(a,b){var c,d;if(quot_isconstant(b[1]))if(quot_isconstant(b[0]))d=Number(b[0])+Number(b[1]),c=(d>>>0)+",";else{var d=Number(b[1]);c=d?"("+b[0]+"+"+d+") >>>0,":b[0]+","}else c="("+b[0]+"+"+b[1]+") >>>0,";a.code.push("MemW1("+c+b[2]+");")},75:function(a,b){if(quot_isconstant(b[1])){var c,d,e;e=4294967295&Number(b[1]),c=7&e,quot_isconstant(b[0])?(d=Number(b[0]),e>=0?d+=e>>3:d-=1+(-1-e>>3)):d=e>=0?7>=e?b[0]:b[0]+"+"+(e>>3):b[0]+"-"+(1+(-1-e>>3)),a.code.push(b[2]+"(Mem1("+d+") & "+(1<<c)+")?1:0);")}else{a.varsused.bitx=!0,a.varsused.addrx=!0;var f=oputil_signify_operand(a,b[1],!0);a.code.push("bitx = "+f+"&7;"),a.code.push("if ("+f+">=0) addrx = "+b[0]+" + ("+f+">>3);"),a.code.push("else addrx = "+b[0]+" - (1+((-1-("+f+"))>>3));"),a.code.push(b[2]+"(Mem1(addrx) & (1<<bitx))?1:0);")}},79:function(a,b){var c,d,e,f;if(quot_isconstant(b[1]))f=4294967295&Number(b[1]),c=7&f,quot_isconstant(b[0])?(d=Number(b[0]),f>=0?d+=f>>3:d-=1+(-1-f>>3)):d=f>=0?7>=f?b[0]:b[0]+"+"+(f>>3):b[0]+"-"+(1+(-1-f>>3)),e=1<<c;else{a.varsused.bitx=!0,a.varsused.addrx=!0;var g=oputil_signify_operand(a,b[1],!0);a.code.push("bitx = "+g+"&7;"),a.code.push("if ("+g+">=0) addrx = "+b[0]+" + ("+g+">>3);"),a.code.push("else addrx = "+b[0]+" - (1+((-1-("+g+"))>>3));"),d="addrx",e="(1<<bitx)"}quot_isconstant(b[2])?a.code.push(Number(b[2])?"MemW1("+d+", Mem1("+d+") | "+e+");":"MemW1("+d+", Mem1("+d+") & ~("+e+"));"):(a.code.push("if ("+b[2]+") MemW1("+d+", Mem1("+d+") | "+e+");"),a.code.push("else MemW1("+d+", Mem1("+d+") & ~("+e+"));"))},80:function(a,b){var c,d=a.offstack.length;c=d?"frame.valstack.length+"+d:"frame.valstack.length",oputil_store(a,b[0],c)},81:function(a,b){var c;if(quot_isconstant(b[0])){var d=Number(b[0]);c=d<a.offstack.length?a.offstack[a.offstack.length-(d+1)]:"frame.valstack[frame.valstack.length-"+(d+1-a.offstack.length)+"]"}else oputil_unload_offstate(a),c="frame.valstack[frame.valstack.length-("+b[0]+"+1)]";oputil_store(a,b[1],c)},82:function(a,b){var c,d;a.offstack.length<2&&transfer_to_offstack(a,2),d=a.offstack.length,c=a.offstack[d-1],a.offstack[d-1]=a.offstack[d-2],a.offstack[d-2]=c},83:function(a,b){oputil_unload_offstate(a),a.varsused.ix=!0,a.varsused.pos=!0,a.varsused.roll=!0,a.varsused.vals1=!0;var c=oputil_signify_operand(a,b[0],!0),d=oputil_signify_operand(a,b[1],!0);a.code.push("if ("+c+" > 0) {"),a.code.push("if ("+d+" > 0) {"),a.code.push("vals1 = "+d+" % "+c+";"),a.code.push("} else {"),a.code.push("vals1 = "+c+" - (-("+d+")) % "+c+";"),a.code.push("}"),a.code.push("if (vals1) {"),a.code.push("pos = frame.valstack.length - "+c+";"),a.code.push("roll = frame.valstack.slice(frame.valstack.length-vals1, frame.valstack.length).concat(frame.valstack.slice(pos, frame.valstack.length-vals1));"),a.code.push("for (ix=0; ix<"+c+"; ix++) { frame.valstack[pos+ix] = roll[ix]; }"),a.code.push("roll = undefined;"),a.code.push("}"),a.code.push("}")},84:function(a,b){if(oputil_unload_offstate(a),quot_isconstant(b[0])){var c,d,e=Number(b[0]);for(c=0;e>c;c++)d=alloc_holdvar(a,!0),a.offstack.push(d),a.code.push(d+"=frame.valstack[frame.valstack.length-"+(e-c)+"];")}else a.varsused.ix=!0,a.varsused.jx=!0,a.code.push("jx = frame.valstack.length-("+b[0]+");"),a.code.push("for (ix=0; ix<"+b[0]+"; ix++) { frame.valstack.push(frame.valstack[jx+ix]); }")},256:function(a,b){var c="do_gestalt(("+b[0]+"),("+b[1]+"))";a.code.push(b[2]+c+");")},257:function(a,b){a.code.push("fatal_error('User debugtrap encountered.', "+b[0]+");")},258:function(a,b){a.code.push(b[0]+"endmem);")},259:function(a,b){a.code.push("change_memsize("+b[0]+",false);"),a.code.push(b[1]+"0);")},272:function(a,b){var c;if(quot_isconstant(b[0])){var d=4294967295&Number(b[0]);c=0==d?"(Math.floor(random_func() * 0x10000) | (Math.floor(random_func() * 0x10000) << 16)) >>>0":d>0?"Math.floor(random_func() * "+d+")":"-Math.floor(random_func() * "+-d+")"}else{var e=oputil_signify_operand(a,b[0],!0),f=alloc_holdvar(a);c=f,a.code.push("if ("+e+" > 0)"),a.code.push(f+" = Math.floor(random_func() * "+e+");"),a.code.push("else if ("+e+" < 0)"),a.code.push(f+" = -Math.floor(random_func() * -"+e+");"),a.code.push("else"),a.code.push(f+" = (Math.floor(random_func() * 0x10000) | (Math.floor(random_func() * 0x10000) << 16)) >>>0;")}a.code.push(b[1]+c+");")},273:function(a,b){a.code.push("set_random("+b[0]+");")},288:function(a,b){a.code.push("// quashing offstack for quit: "+a.offstack.length),a.offstack.length=0,a.offloc.length=0,a.offlocdirty.length=0,a.code.push("done_executing = true; vm_stopped = true;"),a.code.push("return;"),a.path_ends=!0},289:function(a,b){a.code.push(b[0]+"perform_verify());")},290:function(a,b){a.code.push("// quashing offstack for quit: "+a.offstack.length),a.offstack.length=0,a.offloc.length=0,a.offlocdirty.length=0,a.code.push("vm_restart();"),a.code.push("return;"),a.path_ends=!0},291:function(a,b){oputil_unload_offstate(a),a.varsused.ix=!0,oputil_push_callstub(a,b[1]),a.code.push("ix = vm_save("+b[0]+");"),a.code.push("pop_callstub(ix ? 0 : 1);"),a.code.push("return;"),a.path_ends=!0},292:function(a,b){oputil_unload_offstate(a),a.code.push("if (vm_restore("+b[0]+")) {"),a.code.push("pop_callstub((-1)>>>0);"),a.code.push("} else {"),oputil_store(a,b[1],"1"),oputil_unload_offstate(a),a.code.push("pc = "+a.cp+";"),a.code.push("}"),a.code.push("return;"),a.path_ends=!0},293:function(a,b){oputil_unload_offstate(a),oputil_push_callstub(a,b[0]),a.code.push("vm_saveundo();"),a.code.push("pop_callstub(0);"),a.code.push("return;"),a.path_ends=!0},294:function(a,b){oputil_unload_offstate(a),a.code.push("if (vm_restoreundo()) {"),a.code.push("pop_callstub((-1)>>>0);"),a.code.push("} else {"),oputil_store(a,b[0],"1"),oputil_unload_offstate(a),a.code.push("pc = "+a.cp+";"),a.code.push("}"),a.code.push("return;"),a.path_ends=!0},295:function(a,b){a.code.push("protectstart="+b[0]+";"),a.code.push("protectend=protectstart+("+b[1]+");"),a.code.push("if (protectstart==protectend) {"),a.code.push("  protectstart=0; protectend=0;"),a.code.push("}")},368:function(a,b){a.varsused.maddr=!0,a.varsused.mlen=!0,a.varsused.ix=!0,a.code.push("mlen="+b[0]+";"),a.code.push("maddr="+b[1]+";"),a.code.push("for (ix=0; ix<mlen; ix++, maddr++) MemW1(maddr, 0);")},369:function(a,b){a.varsused.msrc=!0,a.varsused.mdest=!0,a.varsused.mlen=!0,a.varsused.ix=!0,a.code.push("mlen="+b[0]+";"),a.code.push("msrc="+b[1]+";"),a.code.push("mdest="+b[2]+";"),a.code.push("if (mdest < msrc) {"),a.code.push("for (ix=0; ix<mlen; ix++, msrc++, mdest++) MemW1(mdest, Mem1(msrc));"),a.code.push("} else {"),a.code.push("msrc += (mlen-1); mdest += (mlen-1);"),a.code.push("for (ix=0; ix<mlen; ix++, msrc--, mdest--) MemW1(mdest, Mem1(msrc));"),a.code.push("}")},376:function(a,b){var c="heap_malloc("+b[0]+")";a.code.push(b[1]+c+");"),a.code.push("assert_heap_valid();")},377:function(a,b){a.code.push("heap_free("+b[0]+");"),a.code.push("assert_heap_valid();")},384:function(a,b){a.code.push("accel_address_map["+b[1]+"] = accel_func_map["+b[0]+"];")},385:function(a,b){a.code.push("if ("+b[0]+" < 9) {"),a.code.push("  accel_params["+b[0]+"] = "+b[1]+";"),a.code.push("}")},336:function(a,b){var c="linear_search(("+b[0]+"),("+b[1]+"),("+b[2]+"),("+b[3]+"),("+b[4]+"),("+b[5]+"),("+b[6]+"))";a.code.push(b[7]+c+");")},337:function(a,b){var c="binary_search(("+b[0]+"),("+b[1]+"),("+b[2]+"),("+b[3]+"),("+b[4]+"),("+b[5]+"),("+b[6]+"))";a.code.push(b[7]+c+");")},338:function(a,b){var c="linked_search(("+b[0]+"),("+b[1]+"),("+b[2]+"),("+b[3]+"),("+b[4]+"),("+b[5]+"))";a.code.push(b[6]+c+");")},112:function(a,b){switch(a.curiosys){case 2:if(quot_isconstant(b[0])){var c=255&Number(b[0]);a.code.push("Glk.glk_put_char("+c+");")}else a.code.push("Glk.glk_put_char(("+b[0]+")&0xff);");break;case 1:oputil_unload_offstate(a),a.code.push("tempcallargs[0]=(("+b[0]+")&0xff);"),oputil_push_callstub(a,"0,0"),a.code.push("enter_function(iosysrock, 1);"),a.code.push("return;"),a.path_ends=!0;break;case 0:a.code.push("// null streamchar "+b[0])}},113:function(a,b){switch(a.curiosys){case 2:var c=oputil_signify_operand(a,b[0]);if(quot_isconstant(b[0])){var d=Number(c).toString(10);a.code.push("Glk.glk_put_jstring("+QuoteEscapeString(d)+", true);")}else a.code.push("Glk.glk_put_jstring(("+c+").toString(10), true);");break;case 1:oputil_unload_offstate(a),a.code.push("stream_num("+a.cp+","+b[0]+", false, 0);"),a.code.push("return;"),a.path_ends=!0;break;case 0:a.code.push("// null streamnum "+b[0])}},114:function(a,b){oputil_unload_offstate(a),a.code.push("if (stream_string("+a.cp+","+b[0]+", 0, 0)) return;")},115:function(a,b){switch(a.curiosys){case 2:if(quot_isconstant(b[0])){var c=Number(b[0]);a.code.push("Glk.glk_put_char_uni("+c+");")}else a.code.push("Glk.glk_put_char_uni("+b[0]+");");break;case 1:oputil_unload_offstate(a),a.code.push("tempcallargs[0]=("+b[0]+");"),oputil_push_callstub(a,"0,0"),a.code.push("enter_function(iosysrock, 1);"),a.code.push("return;"),a.path_ends=!0;break;case 0:a.code.push("// null streamchar "+b[0])}},320:function(a,b){a.code.push(b[0]+"stringtable)")},321:function(a,b){a.code.push("set_string_table("+b[0]+");")},328:function(a,b){a.code.push(b[0]+"iosysmode)"),a.code.push(b[1]+"iosysrock)")},329:function(a,b){if(a.code.push("set_iosys("+b[0]+","+b[1]+");"),quot_isconstant(b[0])){var c=Number(b[0]);a.curiosys=c}else oputil_unload_offstate(a),a.code.push("pc = "+a.cp+";"),a.code.push("return;"),a.path_ends=!0},400:function(a,b){var c=oputil_signify_operand(a,b[0]);if(quot_isconstant(b[0])){var d=Number(c);a.code.push(b[1]+encode_float(d)+");")}else a.code.push(b[1]+"encode_float("+c+"));")},401:function(a,b){a.varsused.valf=!0,a.varsused.res=!0,a.code.push("valf = "+oputil_decode_float(a,b[0])+";"),a.code.push("if (!("+b[0]+" & 0x80000000)) {"),a.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf > 0x7fffffff))"),a.code.push("    res = 0x7fffffff;"),a.code.push("  else"),a.code.push("    res = Math.floor(valf);"),a.code.push("} else {"),a.code.push("  if (isNaN(valf) || !isFinite(valf) || (valf < -0x80000000))"),a.code.push("    res = -0x80000000;"),a.code.push("  else"),a.code.push("    res = Math.ceil(valf);"),a.code.push("}"),a.code.push(b[1]+"res>>>0);")},402:function(a,b){a.varsused.valf=!0,a.varsused.res=!0,a.code.push("valf = "+oputil_decode_float(a,b[0])+";"),a.code.push("if (!("+b[0]+" & 0x80000000)) {"),a.code.push("  if (isNaN(valf) || !isFinite(valf))"),a.code.push("    res = 0x7fffffff;"),a.code.push("  else"),a.code.push("    res = Math.round(valf);"),a.code.push("  if (res > 0x7fffffff) res = 0x7fffffff;"),a.code.push("} else {"),a.code.push("  if (isNaN(valf) || !isFinite(valf))"),a.code.push("    res = -0x80000000;"),a.code.push("  else"),a.code.push("    res = Math.round(valf);"),a.code.push("  if (res < -0x80000000) res = -0x80000000;"),a.code.push("}"),a.code.push(b[1]+"res>>>0);")},408:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.ceil("+c+")));")},409:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.floor("+c+")));")},416:function(a,b){var c=oputil_decode_float(a,b[0]),d=oputil_decode_float(a,b[1]);a.code.push(b[2]+"encode_float("+c+" + "+d+"));")},417:function(a,b){var c=oputil_decode_float(a,b[0]),d=oputil_decode_float(a,b[1]);a.code.push(b[2]+"encode_float("+c+" - "+d+"));")},418:function(a,b){var c=oputil_decode_float(a,b[0]),d=oputil_decode_float(a,b[1]);a.code.push(b[2]+"encode_float("+c+" * "+d+"));")},419:function(a,b){var c=oputil_decode_float(a,b[0]),d=oputil_decode_float(a,b[1]);a.code.push(b[2]+"encode_float("+c+" / "+d+"));")},420:function(a,b){var c=oputil_decode_float(a,b[0],!0),d=oputil_decode_float(a,b[1],!0);a.varsused.modv=!0,a.varsused.quov=!0,a.code.push("modv=("+c+" % "+d+");"),a.code.push("quov=encode_float(("+c+" - modv) / "+d+");"),a.code.push("if (quov == 0x0 || quov == 0x80000000) {"),a.code.push("  quov = (("+b[0]+" ^ "+b[1]+") & 0x80000000) >>>0;"),a.code.push("}"),a.code.push(b[2]+"encode_float(modv));"),a.code.push(b[3]+"quov);")},424:function(a,b){
var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.sqrt("+c+")));")},425:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.exp("+c+")));")},426:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.log("+c+")));")},427:function(a,b){a.varsused.valf=!0;var c=oputil_decode_float(a,b[0],!0),d=oputil_decode_float(a,b[1],!0);a.code.push("if ("+b[0]+" == 0x3f800000) {"),a.code.push("  valf = 0x3f800000;"),a.code.push("} else if ("+b[0]+" == 0xbf800000 && ("+b[1]+" == 0xff800000 || "+b[1]+" == 0x7f800000)) {"),a.code.push("  valf = 0x3f800000;"),a.code.push("} else {"),a.code.push("  valf=encode_float(Math.pow("+c+", "+d+"));"),a.code.push("}"),a.code.push(b[2]+"valf);")},432:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.sin("+c+")));")},433:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.cos("+c+")));")},434:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.tan("+c+")));")},435:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.asin("+c+")));")},436:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.acos("+c+")));")},437:function(a,b){var c=oputil_decode_float(a,b[0]);a.code.push(b[1]+"encode_float(Math.atan("+c+")));")},438:function(a,b){var c=oputil_decode_float(a,b[0]),d=oputil_decode_float(a,b[1]);a.code.push(b[2]+"encode_float(Math.atan2("+c+", "+d+")));")},448:function(a,b){var c,d,e,f;a.varsused.fequal=!0,a.varsused.fdiff=!0,a.code.push("if (("+b[2]+" & 0x7f800000) == 0x7f800000 && ("+b[2]+" & 0x007fffff) != 0) {"),a.code.push("  fequal = 0;"),a.code.push("} else if (("+b[0]+" == 0xff800000 || "+b[0]+" == 0x7f800000) && ("+b[1]+" == 0xff800000 || "+b[1]+" == 0x7f800000)) {"),a.code.push("  fequal = ("+b[0]+" == "+b[1]+");"),a.code.push("} else {"),quot_isconstant(b[2])?(c=Number(b[2]),f=""+decode_float(2147483647&c)):(c="decode_float(("+b[2]+") & 0x7fffffff)",f=alloc_holdvar(a),a.code.push(f+"="+c+";")),d=oputil_decode_float(a,b[0]),e=oputil_decode_float(a,b[1]),a.code.push("  fdiff = "+e+" - "+d+";"),a.code.push("  fequal = (fdiff <= "+f+" && fdiff >= -("+f+"));"),a.code.push("}"),a.code.push("if (fequal) {"),oputil_perform_jump(a,b[3]),a.code.push("}")},449:function(a,b){var c,d,e,f;a.varsused.fequal=!0,a.varsused.fdiff=!0,a.code.push("if (("+b[2]+" & 0x7f800000) == 0x7f800000 && ("+b[2]+" & 0x007fffff) != 0) {"),a.code.push("  fequal = 0;"),a.code.push("} else if (("+b[0]+" == 0xff800000 || "+b[0]+" == 0x7f800000) && ("+b[1]+" == 0xff800000 || "+b[1]+" == 0x7f800000)) {"),a.code.push("  fequal = ("+b[0]+" == "+b[1]+");"),a.code.push("} else {"),quot_isconstant(b[2])?(c=Number(b[2]),f=""+decode_float(2147483647&c)):(c="decode_float(("+b[2]+") & 0x7fffffff)",f=alloc_holdvar(a),a.code.push(f+"="+c+";")),d=oputil_decode_float(a,b[0]),e=oputil_decode_float(a,b[1]),a.code.push("  fdiff = "+e+" - "+d+";"),a.code.push("  fequal = (fdiff <= "+f+" && fdiff >= -("+f+"));"),a.code.push("}"),a.code.push("if (!fequal) {"),oputil_perform_jump(a,b[3]),a.code.push("}")},450:function(a,b){valf0=oputil_decode_float(a,b[0]),valf1=oputil_decode_float(a,b[1]),a.code.push("if ("+valf0+" < "+valf1+") {"),oputil_perform_jump(a,b[2]),a.code.push("}")},451:function(a,b){valf0=oputil_decode_float(a,b[0]),valf1=oputil_decode_float(a,b[1]),a.code.push("if ("+valf0+" <= "+valf1+") {"),oputil_perform_jump(a,b[2]),a.code.push("}")},452:function(a,b){valf0=oputil_decode_float(a,b[0]),valf1=oputil_decode_float(a,b[1]),a.code.push("if ("+valf0+" > "+valf1+") {"),oputil_perform_jump(a,b[2]),a.code.push("}")},453:function(a,b){valf0=oputil_decode_float(a,b[0]),valf1=oputil_decode_float(a,b[1]),a.code.push("if ("+valf0+" >= "+valf1+") {"),oputil_perform_jump(a,b[2]),a.code.push("}")},456:function(a,b){a.code.push("if (("+b[0]+" & 0x7f800000) == 0x7f800000 && ("+b[0]+" & 0x007fffff) != 0) {"),oputil_perform_jump(a,b[1]),a.code.push("}")},457:function(a,b){a.code.push("if ("+b[0]+" == 0xff800000 || "+b[0]+" == 0x7f800000) {"),oputil_perform_jump(a,b[1]),a.code.push("}")},304:function(a,b){var c;if(c=quot_isconstant(b[0])?Glk.call_may_not_return(Number(b[0])):!0,a.code.push("tempglkargs.length = "+b[1]+";"),quot_isconstant(b[1])){var d,e=Number(b[1]);for(d=0;e>d;d++)if(a.offstack.length){var f=pop_offstack_holdvar(a);a.code.push("tempglkargs["+d+"]="+f+";")}else a.code.push("tempglkargs["+d+"]=frame.valstack.pop();");oputil_unload_offstate(a)}else a.varsused.ix=!0,oputil_unload_offstate(a),a.code.push("for (ix=0; ix<"+b[1]+"; ix++) { tempglkargs[ix]=frame.valstack.pop(); }");a.varsused.glkret=!0,a.code.push("glkret = GiDispa.get_function("+b[0]+")(tempglkargs);"),c&&(a.code.push("if (glkret === Glk.DidNotReturn) {"),a.code.push("  resumefuncop = "+oputil_record_funcop(b[2])+";"),a.code.push("  resumevalue = 0;"),a.code.push("  pc = "+a.cp+";"),a.code.push("  done_executing = true;"),a.code.push("  return;"),a.code.push("}")),oputil_store(a,b[2],"glkret")}},ReturnedFromMain={dummy:"The top-level function has returned."},srand_table=void 0,srand_index1,srand_index2,accel_address_map={},accel_params=[0,0,0,0,0,0,0,0,0],accel_func_map={1:function(a,b){if(1>a)return 0;var c=b[0];if(36>c)return 0;if(c>=endmem)return 0;var d=Mem1(c);return d>=224?3:d>=192?2:d>=112&&127>=d&&c>=ramstart?1:0},2:function(a,b){var c=a>0?b[0]:0,d=a>1?b[1]:0;if(1!=accel_func_map[1](a,b))return Glk.glk_put_jstring('\n[** Programming error: tried to find the "." of (something) **]\n'),0;var e=Mem4(c+16);if(!e)return 0;var f=Mem4(e);return e+=4,binary_search(d,2,e,10,f,0,0)},3:function(a,b){var c=a>0?b[0]:0,d=a>1?b[1]:0,e=accel_helper_get_prop(c,d);return 0==e?0:Mem4(e+4)},4:function(a,b){var c=a>0?b[0]:0,d=a>1?b[1]:0,e=accel_helper_get_prop(c,d);return 0==e?0:4*Mem2(e+2)},5:function(a,b){var c,d,e,f,g,h=a>0?b[0]:0,i=a>1?b[1]:0;if(c=accel_func_map[1](a,b),3==c)return i==accel_params[5]?1:0;if(2==c)return i==accel_params[4]?1:0;if(1!=c)return 0;if(i==accel_params[2])return accel_helper_obj_in_class(h)?1:h==accel_params[2]?1:h==accel_params[5]?1:h==accel_params[4]?1:h==accel_params[3]?1:0;if(i==accel_params[3])return accel_helper_obj_in_class(h)?0:h==accel_params[2]?0:h==accel_params[5]?0:h==accel_params[4]?0:h==accel_params[3]?0:1;if(i==accel_params[5]||i==accel_params[4])return 0;if(!accel_helper_obj_in_class(i))return Glk.glk_put_jstring("\n[** Programming error: tried to apply 'ofclass' with non-class **]\n"),0;if(d=accel_helper_get_prop(h,2),0==d)return 0;if(e=Mem4(d+4),0==e)return 0;for(f=Mem2(d+2),g=0;f>g;g++)if(Mem4(e+4*g)==i)return 1;return 0},6:function(a,b){var c,d=a>1?b[1]:0;return c=accel_func_map[3](a,b),0==c?d>0&&d<accel_params[1]?Mem4(accel_params[8]+4*d):(Glk.glk_put_jstring("\n[** Programming error: tried to read (something) **]\n"),0):Mem4(c)},7:function(a,b){var c=a>0?b[0]:0,d=a>1?b[1]:0,e=accel_params[1],f=accel_func_map[1](a,b);return 3==f?d==e+6?1:d==e+7?1:0:2==f?d==e+5?1:0:1!=f?0:d>=e&&e+8>d&&accel_helper_obj_in_class(c)?1:accel_func_map[3](a,b)?1:0}},accel_helper_temp_args=[0,0],tempsearchkey=[],game_image=null,game_signature=null,opt_rethrow_exceptions=null,memmap,stack,frame,vm_started=!1,vm_stopped=!1,tempcallargs,tempglkargs,done_executing,vmfunc_table,vmtextenv_table,decoding_tree,vmstring_table,random_func,ramstart,endgamefile,origendmem,stacksize,startfuncaddr,origstringtable,checksum,pc,stringtable,endmem,protectstart,protectend,iosysmode,iosysrock,undostack,resumefuncop,resumevalue,heapstart,usedlist,freelist,total_execution_time=0,total_function_calls=0,accel_function_calls=0,total_path_calls=0,paths_cached=0,paths_compiled=0,strings_cached=0,strings_compiled=0;return{version:"1.1.1",prepare:quixe_prepare,init:quixe_init,resume:quixe_resume,get_signature:quixe_get_signature,get_statistics:quixe_get_statistics,ReadByte:ReadArgByte,WriteByte:WriteArgByte,ReadWord:ReadArgWord,WriteWord:WriteArgWord,ReadStructField:ReadStructField,WriteStructField:WriteStructField,SetResumeStore:SetResumeStore}}(),GiDispa=function(){function set_vm(a){VM=a}function FuncSpec(a,b,c){this.id=a,this.name=b,this.proto=c}function Prototype(a,b){this.args=a,this.retarg=b}function ArgString(){this.macro="Byte",this.refsize=1}function ArgUnicode(){this.macro="Word",this.refsize=4}function ArgChar(a){this.signed=a,this.macro="Byte",this.refsize=1,this.literal=a?"arg_char_signed":"arg_char_unsigned"}function ArgInt(a){this.signed=a,this.macro="Word",this.refsize=4,this.literal=a?"arg_int_signed":"arg_int_unsigned"}function ArgClass(a){this.name=a,this.macro="Word",this.refsize=4}function ArgStruct(a){this.form=a}function ArgRef(a,b,c,d){this.arg=a,this.passin=b,this.passout=c,this.nonnull=d}function ArgArray(a,b,c,d,e){this.arg=a,this.retained=b,this.passin=c,this.passout=d,this.nonnull=e}function convert_arg(a,b,c){return a instanceof ArgInt?b?a.signed?c+" & 0xFFFFFFFF":c:"0":a instanceof ArgChar?b?a.signed?"cast_signed_char("+c+")":c+" & 0xFF":"0":a instanceof ArgClass?b?'class_obj_from_id("'+a.name+'", '+c+")":"null":"???"}function unconvert_arg(a,b){return a instanceof ArgInt?b+" >>> 0":a instanceof ArgChar?a.signed?"uncast_signed_char("+b+")":b+" & 0xFF":a instanceof ArgClass?'class_obj_to_id("'+a.name+'", '+b+")":"???"}function cast_signed_char(a){return a=255&a,128&a&&(a-=256),a}function uncast_signed_char(a){return a=255&a,128&a&&(a+=4294967040),a}function class_obj_to_id(a,b){return b?b.disprock:0}function class_obj_from_id(a,b){return 0==b?null:class_map[a][b]}function build_function(func){var ix,jx,form,retarg,argpos,argjoin,subargs,arg,refarg,tmpvar,val,retval,ls,mayblock,out=[],locals={},arraycount=0;for(out.push("// no local vars"),out.push("// "+func.id+": "+func.name),form=func.proto,retarg=null,form.retarg&&(retarg=form.retarg.arg),mayblock=Glk.call_may_not_return(func.id),argpos=0,argjoin=[],ix=0;ix<form.args.length;ix++)if(arg=form.args[ix],tmpvar="glka"+ix,argjoin.push(tmpvar),locals[tmpvar]=!0,arg instanceof ArgInt||arg instanceof ArgChar||arg instanceof ArgClass)val=convert_arg(arg,!0,"callargs["+argpos+"]"),out.push(tmpvar+" = "+val+";"),argpos+=1;else if(arg instanceof ArgRef){if(refarg=arg.arg,out.push("if (callargs["+argpos+"] == 0) {"),out.push(arg.nonnull?'  throw("glk '+func.name+': null argument");':"  "+tmpvar+" = null;"),out.push("} else {"),refarg instanceof ArgInt||refarg instanceof ArgChar||refarg instanceof ArgClass)out.push("  "+tmpvar+" = new Glk.RefBox();"),val=convert_arg(refarg,arg.passin,"VM.ReadWord(callargs["+argpos+"])"),out.push("  "+tmpvar+".set_value("+val+");");else{if(!(refarg instanceof ArgStruct))throw"buildfunc: unsupported refarg type: "+func.name;for(subargs=refarg.form.args,out.push("  "+tmpvar+" = new Glk.RefStruct("+subargs.length+");"),jx=0;jx<subargs.length;jx++)val=convert_arg(subargs[jx],arg.passin,"VM.ReadStructField(callargs["+argpos+"], "+jx+")"),out.push("  "+tmpvar+".push_field("+val+");")}out.push("}"),argpos+=1}else if(arg instanceof ArgArray)locals.glklen=!0,refarg=arg.arg,out.push("if (callargs["+argpos+"] == 0) {"),out.push(arg.nonnull?'  throw("glk '+func.name+': null argument");':"  "+tmpvar+" = null;"),out.push("} else {"),out.push("  glklen = callargs["+(argpos+1)+"];"),out.push("  "+tmpvar+" = Array(glklen);"),arg.passin&&(locals.ix=!0,locals.jx=!0,out.push("  for (ix=0, jx=callargs["+argpos+"]; ix<glklen; ix++, jx+="+refarg.refsize+") {"),val=convert_arg(refarg,!0,"VM.Read"+refarg.macro+"(jx)"),out.push("    "+tmpvar+"[ix] = "+val+";"),out.push("  }")),arg.retained&&(0==arraycount&&out.push("  temp_arg_arrays.length = 0;"),arraycount+=1,out.push("  make_arg_array("+tmpvar+", callargs["+argpos+"], glklen, "+refarg.literal+");")),out.push("}"),argpos+=2;else{if(!(arg instanceof ArgString||arg instanceof ArgUnicode))throw"buildfunc: unsupported arg type: "+func.name;locals.ix=!0,locals.jx=!0;var confunc,checkbyte;arg instanceof ArgString?(checkbyte="0xE0",confunc="byte_array_to_string"):(checkbyte="0xE2",confunc="uni_array_to_string"),out.push(tmpvar+" = Array();"),out.push("jx = callargs["+argpos+"];"),out.push("if (VM.ReadByte(jx) != "+checkbyte+') throw("glk '+func.name+': string argument must be unencoded");'),out.push("for (jx+="+arg.refsize+"; true; jx+="+arg.refsize+") {"),out.push("  ix = VM.Read"+arg.macro+"(jx);"),out.push("  if (ix == 0) break;"),out.push("  "+tmpvar+".push(ix);"),out.push("}"),out.push(tmpvar+" = Glk."+confunc+"("+tmpvar+");"),argpos+=1}for(out.push("if (callargs.length != "+argpos+') throw "glk '+func.name+': wrong number of arguments";'),retarg||mayblock?(locals.glkret=!0,retval="glkret = "):retval="",out.push(retval+"Glk.glk_"+func.name+"("+argjoin.join(", ")+");"),mayblock&&(out.push("if (glkret === Glk.DidNotReturn) {"),out.push("  set_blocked_selector("+func.id+", callargs);"),out.push("  return glkret;"),out.push("}")),argpos=0,ix=0;ix<form.args.length;ix++)if(arg=form.args[ix],tmpvar="glka"+ix,arg instanceof ArgInt||arg instanceof ArgChar||arg instanceof ArgClass)argpos+=1;else if(arg instanceof ArgRef){if(refarg=arg.arg,arg.passout){if(out.push("if ("+tmpvar+") {"),refarg instanceof ArgInt||refarg instanceof ArgChar||refarg instanceof ArgClass)val=unconvert_arg(refarg,tmpvar+".get_value()"),out.push("  VM.WriteWord(callargs["+argpos+"], "+val+");");else{if(!(refarg instanceof ArgStruct))throw"buildfunc: unsupported refarg type: "+func.name;for(subargs=refarg.form.args,jx=0;jx<subargs.length;jx++)val=unconvert_arg(subargs[jx],tmpvar+".get_field("+jx+")"),out.push("  VM.WriteStructField(callargs["+argpos+"], "+jx+", "+val+");")}out.push("}")}argpos+=1}else if(arg instanceof ArgArray)refarg=arg.arg,arg.passout&&!arg.retained&&(out.push("if ("+tmpvar+") {"),locals.ix=!0,locals.jx=!0,out.push("  for (ix=0, jx=callargs["+argpos+"]; ix<glklen; ix++, jx+="+refarg.refsize+") {"),val=unconvert_arg(refarg,tmpvar+"[ix]"),out.push("    VM.Write"+refarg.macro+"(jx, "+val+")"),out.push("  }"),out.push("}")),argpos+=2;else{if(!(arg instanceof ArgString||arg instanceof ArgUnicode))throw"buildfunc: unsupported arg type: "+func.name;argpos+=1}0!=arraycount&&out.push("temp_arg_arrays.length = 0;"),retarg?(val=unconvert_arg(retarg,"glkret"),out.push("return "+val+";")):out.push("return 0;"),ls=[];for(val in locals)ls.push(val);return ls.length&&(out[0]="var "+ls.join(", ")+";"),val=out.join("\n"),eval("function _func(callargs) {\n"+val+"\n}"),_func}function get_function(a){var b,c=function_map[a];if(void 0===c){if(b=proto_map[a],void 0===b)throw"dispatch: unknown Glk function: "+a;c=build_function(b),function_map[a]=c}return c}function set_blocked_selector(a,b){blocked_selector=a,blocked_callargs=b.slice(0)}function prepare_resume(a){192==blocked_selector?0!=blocked_callargs[0]&&(VM.WriteStructField(blocked_callargs[0],0,a.get_field(0)>>>0),VM.WriteStructField(blocked_callargs[0],1,class_obj_to_id("window",a.get_field(1))),VM.WriteStructField(blocked_callargs[0],2,a.get_field(2)>>>0),VM.WriteStructField(blocked_callargs[0],3,a.get_field(3)>>>0)):98==blocked_selector&&VM.SetResumeStore(class_obj_to_id("fileref",a)),blocked_selector=null,blocked_callargs=null}function make_arg_array(a,b,c,d){var e;a&&(e={arr:a,addr:b,len:c,arg:d},temp_arg_arrays.push(e))}function retain_array(a){var b,c;if(a){for(c=void 0,b=0;b<temp_arg_arrays.length;b++)if(temp_arg_arrays[b].arr===a){c=temp_arg_arrays[b];break}if(void 0===c)throw"retain_array: array is not an argument";for(b=0;void 0!==retained_arrays[b];b++);retained_arrays[b]=c}}function unretain_array(a){var b,c,d;if(a){for(d=void 0,b=0;b<retained_arrays.length;b++)if(void 0!==retained_arrays[b]&&retained_arrays[b].arr===a){d=retained_arrays[b],delete retained_arrays[b];break}if(void 0===d)throw"unretain_array: array was never retained";if(d.arg instanceof ArgInt)for(b=0,c=d.addr;b<d.len;b++,c+=4)VM.WriteWord(c,d.arr[b]>>>0);else{if(!(d.arg instanceof ArgChar))throw"unretain_array: unsupported refarg type";if(d.arg.signed)for(b=0,c=d.addr;b<d.len;b++,c++)VM.WriteByte(c,uncast_signed_char(d.arr[b]));else for(b=0,c=d.addr;b<d.len;b++,c++)VM.WriteByte(c,255&d.arr[b])}}}function class_register(a,b){if(b.disprock)throw"class_register: object is already registered";b.disprock=last_used_id,last_used_id++,class_map[a][b.disprock]=b}function class_unregister(a,b){if(!b.disprock||void 0===class_map[a][b.disprock])throw"class_unregister: object is not registered";delete class_map[a][b.disprock],b.disprock=void 0}function init_module(){var a,b;last_used_id=1+Math.round(1e3*Math.random());for(a in class_defs)b=class_defs[a],class_map[b]={}}var VM=null,class_defs={0:"window",1:"stream",2:"fileref",3:"schannel"},arg_int_unsigned=new ArgInt(!1),arg_int_signed=new ArgInt(!0),arg_char_unsigned=new ArgChar(!1),arg_char_native=new ArgChar(null),arg_char_signed=new ArgChar(!0),arg_class_window=new ArgClass("window"),arg_class_stream=new ArgClass("stream"),arg_class_fileref=new ArgClass("fileref"),arg_class_schannel=new ArgClass("schannel"),proto_map={1:new FuncSpec(1,"exit",new Prototype([],null)),3:new FuncSpec(3,"tick",new Prototype([],null)),4:new FuncSpec(4,"gestalt",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),5:new FuncSpec(5,"gestalt_ext",new Prototype([arg_int_unsigned,arg_int_unsigned,new ArgArray(arg_int_unsigned,!1,!0,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),32:new FuncSpec(32,"window_iterate",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_window,!1,!0,!0))),33:new FuncSpec(33,"window_get_rock",new Prototype([arg_class_window],new ArgRef(arg_int_unsigned,!1,!0,!0))),34:new FuncSpec(34,"window_get_root",new Prototype([],new ArgRef(arg_class_window,!1,!0,!0))),35:new FuncSpec(35,"window_open",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_window,!1,!0,!0))),36:new FuncSpec(36,"window_close",new Prototype([arg_class_window,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),37:new FuncSpec(37,"window_get_size",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1)],null)),38:new FuncSpec(38,"window_set_arrangement",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,arg_class_window],null)),39:new FuncSpec(39,"window_get_arrangement",new Prototype([arg_class_window,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_class_window,!1,!0,!1)],null)),40:new FuncSpec(40,"window_get_type",new Prototype([arg_class_window],new ArgRef(arg_int_unsigned,!1,!0,!0))),41:new FuncSpec(41,"window_get_parent",new Prototype([arg_class_window],new ArgRef(arg_class_window,!1,!0,!0))),42:new FuncSpec(42,"window_clear",new Prototype([arg_class_window],null)),43:new FuncSpec(43,"window_move_cursor",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),44:new FuncSpec(44,"window_get_stream",new Prototype([arg_class_window],new ArgRef(arg_class_stream,!1,!0,!0))),45:new FuncSpec(45,"window_set_echo_stream",new Prototype([arg_class_window,arg_class_stream],null)),46:new FuncSpec(46,"window_get_echo_stream",new Prototype([arg_class_window],new ArgRef(arg_class_stream,!1,!0,!0))),47:new FuncSpec(47,"set_window",new Prototype([arg_class_window],null)),48:new FuncSpec(48,"window_get_sibling",new Prototype([arg_class_window],new ArgRef(arg_class_window,!1,!0,!0))),64:new FuncSpec(64,"stream_iterate",new Prototype([arg_class_stream,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_stream,!1,!0,!0))),65:new FuncSpec(65,"stream_get_rock",new Prototype([arg_class_stream],new ArgRef(arg_int_unsigned,!1,!0,!0))),66:new FuncSpec(66,"stream_open_file",new Prototype([arg_class_fileref,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),67:new FuncSpec(67,"stream_open_memory",new Prototype([new ArgArray(arg_char_native,!0,!0,!0,!0),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),68:new FuncSpec(68,"stream_close",new Prototype([arg_class_stream,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),69:new FuncSpec(69,"stream_set_position",new Prototype([arg_class_stream,arg_int_signed,arg_int_unsigned],null)),70:new FuncSpec(70,"stream_get_position",new Prototype([arg_class_stream],new ArgRef(arg_int_unsigned,!1,!0,!0))),71:new FuncSpec(71,"stream_set_current",new Prototype([arg_class_stream],null)),72:new FuncSpec(72,"stream_get_current",new Prototype([],new ArgRef(arg_class_stream,!1,!0,!0))),96:new FuncSpec(96,"fileref_create_temp",new Prototype([arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),97:new FuncSpec(97,"fileref_create_by_name",new Prototype([arg_int_unsigned,new ArgString,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),98:new FuncSpec(98,"fileref_create_by_prompt",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),99:new FuncSpec(99,"fileref_destroy",new Prototype([arg_class_fileref],null)),100:new FuncSpec(100,"fileref_iterate",new Prototype([arg_class_fileref,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_fileref,!1,!0,!0))),101:new FuncSpec(101,"fileref_get_rock",new Prototype([arg_class_fileref],new ArgRef(arg_int_unsigned,!1,!0,!0))),102:new FuncSpec(102,"fileref_delete_file",new Prototype([arg_class_fileref],null)),103:new FuncSpec(103,"fileref_does_file_exist",new Prototype([arg_class_fileref],new ArgRef(arg_int_unsigned,!1,!0,!0))),104:new FuncSpec(104,"fileref_create_from_fileref",new Prototype([arg_int_unsigned,arg_class_fileref,arg_int_unsigned],new ArgRef(arg_class_fileref,!1,!0,!0))),128:new FuncSpec(128,"put_char",new Prototype([arg_char_unsigned],null)),129:new FuncSpec(129,"put_char_stream",new Prototype([arg_class_stream,arg_char_unsigned],null)),130:new FuncSpec(130,"put_string",new Prototype([new ArgString],null)),131:new FuncSpec(131,"put_string_stream",new Prototype([arg_class_stream,new ArgString],null)),132:new FuncSpec(132,"put_buffer",new Prototype([new ArgArray(arg_char_native,!1,!0,!1,!0)],null)),133:new FuncSpec(133,"put_buffer_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!0,!1,!0)],null)),134:new FuncSpec(134,"set_style",new Prototype([arg_int_unsigned],null)),135:new FuncSpec(135,"set_style_stream",new Prototype([arg_class_stream,arg_int_unsigned],null)),144:new FuncSpec(144,"get_char_stream",new Prototype([arg_class_stream],new ArgRef(arg_int_signed,!1,!0,!0))),145:new FuncSpec(145,"get_line_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),146:new FuncSpec(146,"get_buffer_stream",new Prototype([arg_class_stream,new ArgArray(arg_char_native,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),160:new FuncSpec(160,"char_to_lower",new Prototype([arg_char_unsigned],new ArgRef(arg_char_unsigned,!1,!0,!0))),161:new FuncSpec(161,"char_to_upper",new Prototype([arg_char_unsigned],new ArgRef(arg_char_unsigned,!1,!0,!0))),176:new FuncSpec(176,"stylehint_set",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned,arg_int_signed],null)),177:new FuncSpec(177,"stylehint_clear",new Prototype([arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],null)),178:new FuncSpec(178,"style_distinguish",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),179:new FuncSpec(179,"style_measure",new Prototype([arg_class_window,arg_int_unsigned,arg_int_unsigned,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),192:new FuncSpec(192,"select",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!0)],null)),193:new FuncSpec(193,"select_poll",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!0)],null)),208:new FuncSpec(208,"request_line_event",new Prototype([arg_class_window,new ArgArray(arg_char_native,!0,!0,!0,!0),arg_int_unsigned],null)),209:new FuncSpec(209,"cancel_line_event",new Prototype([arg_class_window,new ArgRef(new ArgStruct(new Prototype([arg_int_unsigned,arg_class_window,arg_int_unsigned,arg_int_unsigned],null)),!1,!0,!1)],null)),210:new FuncSpec(210,"request_char_event",new Prototype([arg_class_window],null)),211:new FuncSpec(211,"cancel_char_event",new Prototype([arg_class_window],null)),212:new FuncSpec(212,"request_mouse_event",new Prototype([arg_class_window],null)),213:new FuncSpec(213,"cancel_mouse_event",new Prototype([arg_class_window],null)),214:new FuncSpec(214,"request_timer_events",new Prototype([arg_int_unsigned],null)),224:new FuncSpec(224,"image_get_info",new Prototype([arg_int_unsigned,new ArgRef(arg_int_unsigned,!1,!0,!1),new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_int_unsigned,!1,!0,!0))),225:new FuncSpec(225,"image_draw",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed],new ArgRef(arg_int_unsigned,!1,!0,!0))),226:new FuncSpec(226,"image_draw_scaled",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),232:new FuncSpec(232,"window_flow_break",new Prototype([arg_class_window],null)),233:new FuncSpec(233,"window_erase_rect",new Prototype([arg_class_window,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],null)),234:new FuncSpec(234,"window_fill_rect",new Prototype([arg_class_window,arg_int_unsigned,arg_int_signed,arg_int_signed,arg_int_unsigned,arg_int_unsigned],null)),235:new FuncSpec(235,"window_set_background_color",new Prototype([arg_class_window,arg_int_unsigned],null)),240:new FuncSpec(240,"schannel_iterate",new Prototype([arg_class_schannel,new ArgRef(arg_int_unsigned,!1,!0,!1)],new ArgRef(arg_class_schannel,!1,!0,!0))),241:new FuncSpec(241,"schannel_get_rock",new Prototype([arg_class_schannel],new ArgRef(arg_int_unsigned,!1,!0,!0))),242:new FuncSpec(242,"schannel_create",new Prototype([arg_int_unsigned],new ArgRef(arg_class_schannel,!1,!0,!0))),243:new FuncSpec(243,"schannel_destroy",new Prototype([arg_class_schannel],null)),248:new FuncSpec(248,"schannel_play",new Prototype([arg_class_schannel,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),249:new FuncSpec(249,"schannel_play_ext",new Prototype([arg_class_schannel,arg_int_unsigned,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),250:new FuncSpec(250,"schannel_stop",new Prototype([arg_class_schannel],null)),251:new FuncSpec(251,"schannel_set_volume",new Prototype([arg_class_schannel,arg_int_unsigned],null)),252:new FuncSpec(252,"sound_load_hint",new Prototype([arg_int_unsigned,arg_int_unsigned],null)),256:new FuncSpec(256,"set_hyperlink",new Prototype([arg_int_unsigned],null)),257:new FuncSpec(257,"set_hyperlink_stream",new Prototype([arg_class_stream,arg_int_unsigned],null)),258:new FuncSpec(258,"request_hyperlink_event",new Prototype([arg_class_window],null)),259:new FuncSpec(259,"cancel_hyperlink_event",new Prototype([arg_class_window],null)),288:new FuncSpec(288,"buffer_to_lower_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),289:new FuncSpec(289,"buffer_to_upper_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),290:new FuncSpec(290,"buffer_to_title_case_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),291:new FuncSpec(291,"buffer_canon_decompose_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),292:new FuncSpec(292,"buffer_canon_normalize_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!0,!0),arg_int_unsigned],new ArgRef(arg_int_unsigned,!1,!0,!0))),296:new FuncSpec(296,"put_char_uni",new Prototype([arg_int_unsigned],null)),297:new FuncSpec(297,"put_string_uni",new Prototype([new ArgUnicode],null)),298:new FuncSpec(298,"put_buffer_uni",new Prototype([new ArgArray(arg_int_unsigned,!1,!0,!1,!0)],null)),299:new FuncSpec(299,"put_char_stream_uni",new Prototype([arg_class_stream,arg_int_unsigned],null)),300:new FuncSpec(300,"put_string_stream_uni",new Prototype([arg_class_stream,new ArgUnicode],null)),301:new FuncSpec(301,"put_buffer_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!0,!1,!0)],null)),304:new FuncSpec(304,"get_char_stream_uni",new Prototype([arg_class_stream],new ArgRef(arg_int_signed,!1,!0,!0))),305:new FuncSpec(305,"get_buffer_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),306:new FuncSpec(306,"get_line_stream_uni",new Prototype([arg_class_stream,new ArgArray(arg_int_unsigned,!1,!1,!0,!0)],new ArgRef(arg_int_unsigned,!1,!0,!0))),312:new FuncSpec(312,"stream_open_file_uni",new Prototype([arg_class_fileref,arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),313:new FuncSpec(313,"stream_open_memory_uni",new Prototype([new ArgArray(arg_int_unsigned,!0,!0,!0,!0),arg_int_unsigned,arg_int_unsigned],new ArgRef(arg_class_stream,!1,!0,!0))),320:new FuncSpec(320,"request_char_event_uni",new Prototype([arg_class_window],null)),321:new FuncSpec(321,"request_line_event_uni",new Prototype([arg_class_window,new ArgArray(arg_int_unsigned,!0,!0,!0,!0),arg_int_unsigned],null)),336:new FuncSpec(336,"set_echo_line_event",new Prototype([arg_class_window,arg_int_unsigned],null)),337:new FuncSpec(337,"set_terminators_line_event",new Prototype([arg_class_window,new ArgArray(arg_int_unsigned,!1,!0,!1,!1)],null)),352:new FuncSpec(352,"current_time",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),353:new FuncSpec(353,"current_simple_time",new Prototype([arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0))),360:new FuncSpec(360,"time_to_date_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),361:new FuncSpec(361,"time_to_date_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),362:new FuncSpec(362,"simple_time_to_date_utc",new Prototype([arg_int_signed,arg_int_unsigned,new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),363:new FuncSpec(363,"simple_time_to_date_local",new Prototype([arg_int_signed,arg_int_unsigned,new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!1,!0,!0)],null)),364:new FuncSpec(364,"date_to_time_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),365:new FuncSpec(365,"date_to_time_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_unsigned,arg_int_signed],null)),!1,!0,!0)],null)),
366:new FuncSpec(366,"date_to_simple_time_utc",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0))),367:new FuncSpec(367,"date_to_simple_time_local",new Prototype([new ArgRef(new ArgStruct(new Prototype([arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed,arg_int_signed],null)),!0,!1,!0),arg_int_unsigned],new ArgRef(arg_int_signed,!1,!0,!0)))},function_map={},blocked_selector=null,blocked_callargs=null,temp_arg_arrays=[],retained_arrays=[],class_map={},last_used_id;return init_module(),{set_vm:set_vm,get_function:get_function,prepare_resume:prepare_resume,class_register:class_register,class_unregister:class_unregister,class_obj_to_id:class_obj_to_id,class_obj_from_id:class_obj_from_id,retain_array:retain_array,unretain_array:unretain_array}}();